<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchMate - AI Research Assistant | Elevify</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antic+Slab&family=Quicksand:wght@300..700&family=Sora:wght@100..800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Your custom CSS file -->
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Button styling */
        .btn {
            border-radius: 30px;
            font-weight: 400;
            font-family: 'Sora', sans-serif;
            font-size: 0.9rem;
            padding: 0.5rem 1.2rem;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: normal;
        }

        .btn-primary {
            background-color: #FFbf23;
            border-color: #FFbf23;
            color: #000;
        }

        .btn-primary:hover {
            background-color: #000;
            border-color: #fff;
            color: #fff;
        }

        .btn-outline-primary {
            background-color: transparent;
            color: #000;
            border-color: #000;
        }

        .btn-outline-primary:hover {
            background-color: #000;
            color: #fff;
            border-color: #fff;
        }

        .btn-outline-secondary {
            background-color: transparent;
            color: #6c757d;
            border-color: #6c757d;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: #fff;
            border-color: #6c757d;
        }

        .btn-outline-dark {
            color: #333;
            border-color: #333;
            background-color: transparent;
        }

        .btn-outline-dark:hover {
            background-color: #333;
            color: #fff;
            border-color: #333;
        }

        .btn-get-started {
            background-color: #FFbf23;
            color: #333;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 30px;
            border: none;
        }

        .btn-get-started:hover {
            background-color: #000;
            color: #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .btn-lg {
            padding: 0.7rem 2rem;
            font-size: 1.1rem;
        }

        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.875rem;
        }

        .btn-warning {
            background-color: #FFbf23;
            border-color: #FFbf23;
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e6a71f;
            border-color: #e6a71f;
            color: #000;
        }

        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
            color: #fff;
        }

        .tool-page-hero {
            background-color: #f9f9f9;
            padding: 3rem 0 2rem;
            margin-bottom: 3rem;
        }
        
        .tool-page-hero h1 {
            font-size: 2.5rem;
            color: #14697D;
            margin-bottom: 1rem;
            font-family: 'Antic Slab', serif;
        }
        
        .tool-page-hero .lead {
            color: #666;
            font-size: 1.2rem;
            font-family: 'Quicksand', sans-serif;
        }
        
        .content-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .research-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            background: #f8f9fa;
        }
        
        .research-card:hover {
            border-color: #14697D;
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(20, 105, 125, 0.2);
        }
        
        .research-card.selected {
            border-color: #FFbf23 !important;
            background-color: #fffbf0 !important;
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(255, 191, 35, 0.3);
        }
        
        .citation-style {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .citation-style:hover {
            border-color: #14697D;
            background-color: #f9f9f9;
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(20, 105, 125, 0.2);
        }
        
        .citation-style.selected {
            border-color: #FFbf23 !important;
            background-color: #fffbf0 !important;
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(255, 191, 35, 0.3);
        }
        
        .loading-spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #14697D;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background-color: #14697D;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-family: 'Sora', sans-serif;
            margin-right: 10px;
        }
        
        .features-highlight {
            background-color: #FFF0F5;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-control, .form-select {
            border-radius: 20px;
            border: 1px solid #ddd;
            padding: 0.75rem 1.25rem;
            font-family: 'Quicksand', sans-serif;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #14697D;
            box-shadow: 0 0 0 0.2rem rgba(20, 105, 125, 0.25);
        }

        .form-label {
            font-family: 'Quicksand', sans-serif;
            font-weight: 600;
        }
        
        .research-preview {
            background-color: #f9f9f9;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        .research-disclaimer {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        
        .export-option {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-option:hover {
            border-color: #14697D;
            background-color: #f9f9f9;
        }
        
        .export-option i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #14697D;
        }

        .research-tab {
            background: none;
            border: none;
            padding: 12px 24px;
            margin: 0 6px;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-radius: 30px 30px 0 0;
            transition: all 0.3s ease;
        }
        
        .research-tab:hover {
            color: #333;
            background-color: #f0f0f0;
        }
        
        .research-tab.active {
            background-color: #14697D;
            color: white;
        }

        .research-tabs {
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .source-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #14697D;
        }

        .source-item h6 {
            color: #14697D;
            margin-bottom: 0.5rem;
        }

        .keyword-tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }

        .keyword-tag:hover {
            background: #14697D;
            color: white;
            cursor: pointer;
        }

        .note-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .note-timestamp {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: #6c757d;
        }

        .plagiarism-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .plagiarism-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .plagiarism-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .file-upload-area {
            border: 2px dashed #14697D;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            background: #e9ecef;
        }

        .file-upload-area.dragover {
            border-color: #FFbf23;
            background: #fffbf0;
        }

        .research-overview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .subtopic-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .subtopic-card:hover {
            transform: translateY(-2px);
        }

        .citation-preview {
            background: #f8f9fa;
            border-left: 4px solid #14697D;
            padding: 1rem;
            border-radius: 0 10px 10px 0;
            font-family: 'Times New Roman', serif;
            margin: 1rem 0;
        }

        /* Enhanced Notes Section Styles */
        .notes-library {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .saved-note {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-note:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .saved-note.selected {
            border-color: #FFbf23;
            background-color: #fffbf0;
        }

        .note-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
        }

        .saved-note:hover .note-actions {
            display: block;
        }

        .note-preview {
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }

        .ai-suggestion {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .ai-suggestion .suggestion-actions {
            margin-top: 0.5rem;
        }

        .tag-input-container {
            position: relative;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .tag-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .tag-suggestion:hover {
            background: #f8f9fa;
        }

        .export-progress {
            display: none;
            margin-top: 1rem;
        }

        .export-progress .progress {
            height: 20px;
            border-radius: 10px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .custom-toast {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .tool-page-hero h1 {
                font-size: 2rem;
            }
            
            .content-card {
                padding: 1.5rem;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .export-option {
                min-width: auto;
            }
        }
        /* ===== PRICING TIER CARDS ===== */

/* Base card styling */
.pricing-tier-card {
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
    height: 100%;
    background: #f8f9fa;
    position: relative;
    overflow: visible;
    border-radius: 15px;
}

/* Card body styling */
.pricing-tier-card .card-body {
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
}

/* Icon styling */
.pricing-tier-card i {
    color: #14697D;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

/* Card title styling */
.pricing-tier-card h6 {
    font-family: 'Antic Slab', serif;
    font-weight: 400;
    font-size: 1.2rem;
    color: #333;
    margin-bottom: 0.5rem;
}

/* Card description */
.pricing-tier-card small {
    font-family: 'Quicksand', sans-serif;
    color: #666;
    margin-bottom: 1rem;
    display: block;
}

/* Price display styling */
.price-display {
    font-family: 'Sora', sans-serif;
    margin-bottom: 1.5rem;
}

.price-display span {
    font-size: 2.2rem;
    font-weight: bold;
    color: #14697D;
}

.price-display small {
    font-size: 0.9rem;
    color: #666;
    font-weight: normal;
}

/* Features list styling */
.features-list {
    min-height: 80px;
    width: 100%;
    text-align: left;
    margin-top: auto;
}

.features-list div {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.features-list small {
    font-family: 'Quicksand', sans-serif;
    font-size: 0.85rem;
    margin: 0;
}

.features-list i {
    font-size: 0.8rem;
    margin-right: 0.5rem;
    width: 12px;
}

/* Badge styling */
.pricing-tier-card .badge {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 0.7rem;
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
    font-family: 'Sora', sans-serif;
    font-weight: 600;
    z-index: 5;
}

/* ===== HOVER EFFECTS ===== */
.pricing-tier-card:hover {
    border-color: #14697D;
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(20, 105, 125, 0.2);
    background-color: #ffffff;
}

.pricing-tier-card:hover i {
    color: #0f5566;
}

/* ===== SELECTED STATE (YELLOW HIGHLIGHT) ===== */
.pricing-tier-card.selected {
    border-color: #FFbf23 !important;
    background-color: #fffbf0 !important;
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 35px rgba(255, 191, 35, 0.4);
    z-index: 10;
}

.pricing-tier-card.selected h6 {
    color: #14697D;
}

.pricing-tier-card.selected i {
    color: #FFbf23;
    transform: scale(1.1);
}

.pricing-tier-card.selected .price-display span {
    color: #FFbf23;
}

/* ===== GET SELECTED PLAN BUTTON ===== */
#getSelectedPlan {
    font-family: 'Sora', sans-serif;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 1rem 2rem;
    border-radius: 15px;
    transition: all 0.3s ease;
    border: none;
    width: 100%;
    margin-top: 1.5rem;
}

#getSelectedPlan:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

#getSelectedPlan:enabled {
    background-color: #14697D;
    border-color: #14697D;
    color: white;
}

#getSelectedPlan:enabled:hover {
    background-color: #0f5566;
    border-color: #0f5566;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(20, 105, 125, 0.3);
}

#getSelectedPlan:enabled:active {
    transform: translateY(0);
}

/* Button icon */
#getSelectedPlan i {
    margin-right: 0.5rem;
}

/* ===== RESPONSIVE DESIGN ===== */

/* Tablet and below */
@media (max-width: 992px) {
    .pricing-tier-card .card-body {
        padding: 1.5rem 1rem;
    }
    
    .pricing-tier-card i {
        font-size: 2rem;
    }
    
    .price-display span {
        font-size: 1.8rem;
    }
    
    .features-list {
        min-height: 70px;
    }
}

/* Mobile devices */
@media (max-width: 768px) {
    #upgradeModal .modal-body {
        padding: 1.5rem;
    }
    
    .pricing-tier-card {
        margin-bottom: 1rem;
    }
    
    .pricing-tier-card.selected {
        transform: translateY(-5px) scale(1.01);
        box-shadow: 0 8px 25px rgba(255, 191, 35, 0.3);
    }
    
    .pricing-tier-card .card-body {
        padding: 1.5rem;
    }
    
    #getSelectedPlan {
        font-size: 1rem;
        padding: 0.875rem 1.5rem;
    }
}

/* Small mobile devices */
@media (max-width: 576px) {
    #upgradeModal .modal-body {
        padding: 1rem;
    }
    
    .price-display span {
        font-size: 1.6rem !important;
    }
    
    .features-list {
        text-align: center !important;
        min-height: 60px;
    }
    
    .pricing-tier-card h6 {
        font-size: 1.1rem;
    }
    
    .pricing-tier-card i {
        font-size: 1.8rem;
    }
    
    .pricing-tier-card .badge {
        font-size: 0.6rem;
        padding: 0.3rem 0.5rem;
    }
}

/* ===== ANIMATION ENHANCEMENTS ===== */

/* Smooth transitions for all interactive elements */
.pricing-tier-card,
.pricing-tier-card i,
.pricing-tier-card h6,
.pricing-tier-card .price-display span,
#getSelectedPlan {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Subtle pulse animation for selected state */
.pricing-tier-card.selected {
    animation: selectedPulse 0.6s ease-out;
}

@keyframes selectedPulse {
    0% {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 35px rgba(255, 191, 35, 0.4);
    }
    50% {
        transform: translateY(-10px) scale(1.03);
        box-shadow: 0 15px 40px rgba(255, 191, 35, 0.5);
    }
    100% {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 35px rgba(255, 191, 35, 0.4);
    }
}

/* Modal entrance animation */
#upgradeModal.fade .modal-dialog {
    transition: transform 0.4s ease-out, opacity 0.4s ease-out;
}

#upgradeModal.fade:not(.show) .modal-dialog {
    transform: translate(0, -25px) scale(0.95);
    opacity: 0;
}

#upgradeModal.fade.show .modal-dialog {
    transform: translate(0, 0) scale(1);
    opacity: 1;
}
    </style>
</head>
<body>
    <header>
        <div class="container-nav">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <div class="logo-container">
                            <img src="/img/logo.svg" alt="logo">
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <nav>
                       
                        <a href="/#tools" class="btn btn-outline-dark me-2">AI Tools</a>
                        <a href="/#pricing" class="btn btn-outline-dark me-2">Pricing</a>
                        <a href="#" class="btn btn-get-started">Get Started</a>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Tool Hero Section -->
        <section class="tool-page-hero">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1>ResearchMate - AI Research Assistant</h1>
                        <p class="lead">Gather, organize, summarize, and cite information with AI-powered research tools designed for students, professionals, and content creators.</p>
                    </div>
                    <div class="col-lg-4 text-center">
                        <img src="/img/img3.svg" alt="Research Tools" style="max-height: 150px;" class="float-animation">
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <div class="container">
            <div class="row">
                <!-- Left Column -->
                <div class="col-lg-4 mb-4">
                    <div class="content-card">
                        <h5><i class="fas fa-search" style="color: #14697D;"></i> How It Works</h5>
                        <ol class="mt-3">
                            <div><span class="step-number">1</span> Start with topic exploration</div>
                            <div class="mt-2"><span class="step-number">2</span> Upload or input sources</div>
                            <div class="mt-2"><span class="step-number">3</span> AI summarizes & organizes</div>
                            <div class="mt-2"><span class="step-number">4</span> Generate citations & notes</div>
                            <div class="mt-2"><span class="step-number">5</span> Export research materials</div>
                        </ol>
                    </div>

                    <div class="features-highlight">
                        <h5><i class="fas fa-brain" style="color: #FFbf23;"></i> AI Capabilities</h5>
                        <ul class="list-unstyled mt-3">
                            <li class="mb-2"><i class="fas fa-check-circle" style="color: #14697D;"></i> Topic exploration & mapping</li>
                            <li class="mb-2"><i class="fas fa-check-circle" style="color: #14697D;"></i> Smart content summarization</li>
                            <li class="mb-2"><i class="fas fa-check-circle" style="color: #14697D;"></i> Automatic citation generation</li>
                            <li class="mb-2"><i class="fas fa-check-circle" style="color: #14697D;"></i> Plagiarism detection</li>
                            <li class="mb-2"><i class="fas fa-check-circle" style="color: #14697D;"></i> AI-assisted note taking</li>
                            <li><i class="fas fa-check-circle" style="color: #14697D;"></i> Multi-format export</li>
                        </ul>
                    </div>

                    <div class="content-card">
                        <h5><i class="fas fa-graduation-cap" style="color: #A82C2C;"></i> Research Types</h5>
                        <div class="mt-3">
                            <div class="mb-2"><i class="fas fa-book" style="color: #14697D;"></i> Academic Papers</div>
                            <div class="mb-2"><i class="fas fa-blog" style="color: #14697D;"></i> Blog Posts & Articles</div>
                            <div class="mb-2"><i class="fas fa-presentation" style="color: #14697D;"></i> Presentations</div>
                            <div class="mb-2"><i class="fas fa-chart-bar" style="color: #14697D;"></i> Business Reports</div>
                            <div class="mb-2"><i class="fas fa-newspaper" style="color: #14697D;"></i> Journalism Research</div>
                            <div class="mb-2"><i class="fas fa-flask" style="color: #14697D;"></i> Scientific Studies</div>
                            <div class="mb-2"><i class="fas fa-history" style="color: #14697D;"></i> Historical Research</div>
                            <div><i class="fas fa-plus" style="color: #14697D;"></i> Custom Projects</div>
                        </div>
                    </div>

                    <div class="research-disclaimer">
                        <h6><i class="fas fa-exclamation-triangle me-2" style="color: #856404;"></i>Research Guidelines</h6>
                        <p class="small mb-0">Always verify AI-generated summaries and citations. Cross-reference sources and maintain academic integrity in your research.</p>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-lg-8">
                    <div class="content-card">
                        <h4 class="mb-4">AI Research Assistant</h4>
                        
                        <!-- Usage Tracker -->
                        <div class="alert alert-info d-flex align-items-center mb-4" id="usageTracker">
                            <i class="fas fa-info-circle me-2"></i>
                            <div class="flex-grow-1">
                                <strong>Free Research Sessions:</strong> <span id="remainingUses">5</span> / 5 this month
                                <div class="small mt-1">Resets on: <span id="resetDate">1st of next month</span></div>
                            </div>
                           <button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade</button>
                        </div>

                        <!-- Research Tabs -->
                        <div class="research-tabs mb-4">
                            <button class="research-tab active" data-tab="explore">Topic Exploration</button>
                            <button class="research-tab" data-tab="summarize">Smart Summarization</button>
                            <button class="research-tab" data-tab="citations">Citations & References</button>
                            <button class="research-tab" data-tab="plagiarism">Plagiarism Check</button>
                            <button class="research-tab" data-tab="notes">Notes & Export</button>
                        </div>

                        <!-- Topic Exploration Section -->
                        <div id="exploreSection" class="tab-content active">
                            <form id="exploreForm">
                                <div class="mb-4">
                                    <label for="researchTopic" class="form-label fw-bold">Research Topic or Question</label>
                                    <textarea class="form-control" id="researchTopic" name="researchTopic" rows="3" placeholder="Enter your research topic, question, or thesis statement. Be as specific as possible for better AI insights..." required></textarea>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Research Scope</label>
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100 selected" data-scope="overview">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-eye mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Overview</h6>
                                                    <small class="text-muted">Literature review</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="focused">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-crosshairs mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Focused</h6>
                                                    <small class="text-muted">Specific angles</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="deep">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-microscope mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Deep Dive</h6>
                                                    <small class="text-muted">Comprehensive</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="comparative">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-balance-scale mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Comparative</h6>
                                                    <small class="text-muted">Multiple angles</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="historical">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-history mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Historical</h6>
                                                    <small class="text-muted">Timeline analysis</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="theoretical">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-lightbulb mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Theoretical</h6>
                                                    <small class="text-muted">Conceptual framework</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="empirical">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-chart-line mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Empirical</h6>
                                                    <small class="text-muted">Data-driven study</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="research-card card h-100" data-scope="systematic">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-sitemap mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                                    <h6>Systematic</h6>
                                                    <small class="text-muted">Structured approach</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" id="selectedScope" name="researchScope" value="overview">

                                <div class="mb-4">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="includeStatistics" checked>
                                        <label class="form-check-label" for="includeStatistics">
                                            Include relevant statistics and data
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="generateKeywords" checked>
                                        <label class="form-check-label" for="generateKeywords">
                                            Generate related keywords and synonyms
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="suggestSources">
                                        <label class="form-check-label" for="suggestSources">
                                            Suggest credible sources and databases
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-search me-2"></i> Explore Topic
                                </button>
                            </form>
                        </div>

                        <!-- Smart Summarization Section -->
                        <div id="summarizeSection" class="tab-content">
                            <form id="summarizeForm">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Upload Sources or Add Text</label>
                                    
                                    <!-- File Upload Area -->
                                    <div class="file-upload-area mb-3" id="fileUploadArea">
                                        <input type="file" class="d-none" id="sourceFiles" multiple accept=".pdf,.doc,.docx,.txt">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #14697D; margin-bottom: 1rem;"></i>
                                        <div>
                                            <strong>Drag & drop files here or click to browse</strong>
                                            <div class="small text-muted mt-2">Supported: PDF, DOC, DOCX, TXT (Max 10MB each)</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Text Input Option -->
                                    <div class="mb-3">
                                        <label for="sourceText" class="form-label">Or paste text directly</label>
                                        <textarea class="form-control" id="sourceText" name="sourceText" rows="8" placeholder="Paste articles, research papers, or any long-form content for AI summarization..."></textarea>
                                        <div class="form-text">Maximum 10,000 words per input</div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Summary Options</label>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="citation-style selected" data-summary="bullets">
                                                <i class="fas fa-list-ul mb-2" style="color: #14697D;"></i>
                                                <div>Bullet Points</div>
                                                <small class="text-muted">Key highlights</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="citation-style" data-summary="abstract">
                                                <i class="fas fa-paragraph mb-2" style="color: #14697D;"></i>
                                                <div>Abstract</div>
                                                <small class="text-muted">Academic style</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="citation-style" data-summary="tldr">
                                                <i class="fas fa-bolt mb-2" style="color: #14697D;"></i>
                                                <div>TL;DR</div>
                                                <small class="text-muted">Quick summary</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" id="selectedSummaryStyle" name="summaryStyle" value="bullets">

                                <div class="mb-4">
                                    <label for="summaryLength" class="form-label fw-bold">Summary Length</label>
                                    <select class="form-select" id="summaryLength" name="summaryLength">
                                        <option value="short">Short (2-3 key points)</option>
                                        <option value="medium" selected>Medium (5-7 main points)</option>
                                        <option value="long">Long (Detailed breakdown)</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-compress-alt me-2"></i> Summarize Content
                                </button>
                            </form>
                        </div>

                        <!-- Citations & References Section -->
                        <div id="citationsSection" class="tab-content">
                            <form id="citationsForm">
                                <div class="mb-4">
                                    <label for="sourceUrl" class="form-label fw-bold">Source Information</label>
                                    <input type="url" class="form-control mb-3" id="sourceUrl" name="sourceUrl" placeholder="Paste URL, DOI, or article link for automatic data extraction">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <input type="text" class="form-control" id="authorName" name="authorName" placeholder="Author(s)">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <input type="text" class="form-control" id="publicationTitle" name="publicationTitle" placeholder="Title">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <input type="text" class="form-control" id="journalName" name="journalName" placeholder="Journal/Publisher">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <input type="text" class="form-control" id="publicationDate" name="publicationDate" placeholder="Publication Date">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <input type="text" class="form-control" id="pageNumbers" name="pageNumbers" placeholder="Page Numbers">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Citation Style</label>
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="citation-style selected" data-style="apa">
                                                <i class="fas fa-graduation-cap mb-2" style="color: #14697D;"></i>
                                                <div>APA</div>
                                                <small class="text-muted">7th Edition</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="citation-style" data-style="mla">
                                                <i class="fas fa-book mb-2" style="color: #14697D;"></i>
                                                <div>MLA</div>
                                                <small class="text-muted">9th Edition</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="citation-style" data-style="chicago">
                                                <i class="fas fa-university mb-2" style="color: #14697D;"></i>
                                                <div>Chicago</div>
                                                <small class="text-muted">17th Edition</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="citation-style" data-style="harvard">
                                                <i class="fas fa-scroll mb-2" style="color: #14697D;"></i>
                                                <div>Harvard</div>
                                                <small class="text-muted">Standard</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" id="selectedCitationStyle" name="citationStyle" value="apa">

                                <div class="mb-4">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="addToBibliography" checked>
                                        <label class="form-check-label" for="addToBibliography">
                                            Add to bibliography automatically
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="validateSource">
                                        <label class="form-check-label" for="validateSource">
                                            Validate source credibility
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-quote-left me-2"></i> Generate Citation
                                </button>
                            </form>
                        </div>

                        <!-- Plagiarism Check Section -->
                        <div id="plagiarismSection" class="tab-content">
                            <form id="plagiarismForm">
                                <div class="mb-4">
                                    <label for="plagiarismText" class="form-label fw-bold">Text to Check</label>
                                    <textarea class="form-control" id="plagiarismText" name="plagiarismText" rows="10" placeholder="Paste your text here for originality checking. The AI will scan for potential plagiarism and suggest improvements..." required></textarea>
                                    <div class="form-text">Maximum 5,000 words</div>
                                </div>

                                <div class="mb-4">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkSimilarity" checked>
                                        <label class="form-check-label" for="checkSimilarity">
                                            Check similarity against web sources
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkParaphrasing" checked>
                                        <label class="form-check-label" for="checkParaphrasing">
                                            Detect inadequate paraphrasing
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="suggestParaphrases">
                                        <label class="form-check-label" for="suggestParaphrases">
                                            Provide paraphrasing suggestions
                                        </label>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-shield-alt me-2"></i> Check Originality
                                </button>
                            </form>
                        </div>

                        <!-- Enhanced Notes & Export Section -->
                        <div id="notesSection" class="tab-content">
                            <!-- Notes Library -->
                            <div class="notes-library mb-4" id="notesLibrary">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="fas fa-book me-2"></i>Saved Notes</h6>
                                    <div class="input-group" style="max-width: 300px;">
                                        <input type="text" class="form-control form-control-sm" id="noteSearch" placeholder="Search notes...">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" id="searchNotesBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="savedNotesList">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-sticky-note fa-3x mb-3"></i>
                                        <p>No saved notes yet. Create your first note below!</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Note Creation/Editing Form -->
                            <form id="notesForm">
                                <div class="mb-4">
                                    <label for="noteTitle" class="form-label fw-bold">Note Title</label>
                                    <input type="text" class="form-control" id="noteTitle" name="noteTitle" placeholder="Give your note a descriptive title">
                                </div>

                                <div class="mb-4">
                                    <label for="noteContent" class="form-label fw-bold">Note Content</label>
                                    <textarea class="form-control" id="noteContent" name="noteContent" rows="8" placeholder="Write your research notes here. AI will help organize and suggest improvements..." required></textarea>
                                    <div class="form-text">
                                        <span id="noteWordCount">0</span> words
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="noteTags" class="form-label fw-bold">Tags & Keywords</label>
                                    <div class="tag-input-container">
                                        <input type="text" class="form-control" id="noteTags" name="noteTags" placeholder="Add comma-separated tags for easy searching (e.g., methodology, statistics, conclusion)">
                                        <div class="tag-suggestions" id="tagSuggestions"></div>
                                    </div>
                                    <div class="mt-2" id="selectedTags"></div>
                                </div>

                                <div class="mb-4">
                                    <label for="noteCategory" class="form-label fw-bold">Category</label>
                                    <select class="form-select" id="noteCategory" name="noteCategory">
                                        <option value="">Select a category</option>
                                        <option value="research">Research</option>
                                        <option value="quotes">Quotes</option>
                                        <option value="ideas">Ideas</option>
                                        <option value="analysis">Analysis</option>
                                        <option value="methodology">Methodology</option>
                                        <option value="conclusions">Conclusions</option>
                                        <option value="references">References</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="aiEnhancement">
                                        <label class="form-check-label" for="aiEnhancement">
                                            AI enhancement suggestions
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="autoTimestamp" checked>
                                        <label class="form-check-label" for="autoTimestamp">
                                            Add timestamp automatically
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="linkSources">
                                        <label class="form-check-label" for="linkSources">
                                            Link to related sources
                                        </label>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                                        <i class="fas fa-sticky-note me-2"></i> <span id="saveButtonText">Save Note</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg" id="clearNoteBtn">
                                        <i class="fas fa-times me-2"></i> Clear
                                    </button>
                                </div>
                            </form>

                            <!-- AI Suggestions Panel -->
                            <div id="aiSuggestionsPanel" style="display: none;">
                                <div class="ai-suggestion">
                                    <h6><i class="fas fa-lightbulb me-2"></i>AI Enhancement Suggestions</h6>
                                    <div id="aiSuggestionsContent"></div>
                                    <div class="suggestion-actions">
                                        <button class="btn btn-sm btn-primary" id="applySuggestionsBtn">
                                            <i class="fas fa-check me-1"></i> Apply Suggestions
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="dismissSuggestionsBtn">
                                            <i class="fas fa-times me-1"></i> Dismiss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Container -->
                    <div id="resultsContainer" class="content-card" style="display: none;">
                        <h4 class="mb-4" id="resultsTitle">Research Results</h4>
                        
                        <!-- Research Preview -->
                        <div class="research-preview mb-4" id="researchPreview">
                            <!-- Generated research content will appear here -->
                        </div>
                        
                        <!-- Keywords Panel -->
                        <div id="keywordsPanel" style="display: none;">
                            <h6><i class="fas fa-tags me-2"></i>Related Keywords</h6>
                            <div id="keywordsList" class="mb-3">
                                <!-- Keywords will appear here -->
                            </div>
                        </div>
                        
                        <!-- Sources Panel -->
                        <div id="sourcesPanel" style="display: none;">
                            <h6><i class="fas fa-link me-2"></i>Suggested Sources</h6>
                            <div id="sourcesList" class="mb-3">
                                <!-- Sources will appear here -->
                            </div>
                        </div>
                        
                        <!-- Export Options -->
                        <div class="export-options">
                            <div class="export-option" id="exportWord">
                                <i class="fas fa-file-word"></i>
                                <div>Download Word</div>
                                <small class="text-muted">.docx format</small>
                            </div>
                            <div class="export-option" id="copyContent">
                                <i class="fas fa-copy"></i>
                                <div>Copy Text</div>
                                <small class="text-muted">To clipboard</small>
                            </div>
                            <div class="export-option" id="exportPDF">
                                <i class="fas fa-file-pdf"></i>
                                <div>Export PDF</div>
                                <small class="text-muted">.pdf format</small>
                            </div>
                            <div class="export-option" id="exportBibliography">
                                <i class="fas fa-book-open"></i>
                                <div>Bibliography</div>
                                <small class="text-muted">Citations only</small>
                            </div>
                            <div class="export-option" id="exportNotes">
                                <i class="fas fa-sticky-note"></i>
                                <div>Export Notes</div>
                                <small class="text-muted">All saved notes</small>
                            </div>
                            <div class="export-option" id="exportFullReport">
                                <i class="fas fa-file-alt"></i>
                                <div>Full Report</div>
                                <small class="text-muted">Complete research</small>
                            </div>
                        </div>

                        <!-- Export Progress -->
                        <div class="export-progress" id="exportProgress">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small id="exportProgressText">Preparing export...</small>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex gap-2">
                            <button class="btn btn-outline-primary" id="editResultBtn">
                                <i class="fas fa-edit me-1"></i> Edit Result
                            </button>
                            <button class="btn btn-outline-secondary" id="newResearchBtn">
                                <i class="fas fa-plus me-1"></i> New Research
                            </button>
                            <button class="btn btn-outline-success" id="saveToNotesBtn">
                                <i class="fas fa-save me-1"></i> Save to Notes
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner"></div>
                </div>
            </div>
        </div>
        
        <!-- CTA Section -->
        <section class="py-5 mt-5" style="background-color: #f9f9f9;">
            <div class="container text-center">
                <h2 class="mb-4">Ready to <span style="color: #14697D;">accelerate</span> your research?</h2>
                <p class="lead mb-4">Join thousands of researchers who've transformed their workflow with Elevify's complete AI toolkit.</p>
                <a href="/#pricing" class="btn btn-primary btn-lg">
                    <i class="fas fa-rocket me-2"></i> Start Building
                </a>
            </div>
        </section>
    </main>

    <footer class="py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h1 class="brand-logo" style="font-size: 1.8rem;">elevify<span class="accent-dot" style="color: #FFbf23;">.</span></h1>
                    <p>Elevate your potential with AI-powered tools that help you work smarter, not harder.</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="/">Home</a></li>
                        <li><a href="/#tools">Tools</a></li>
                        <li><a href="/#pricing">Pricing</a></li>
                        <li><a href="/#contact">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Connect With Us</h5>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <p>&copy; 2025 by Elo.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Upgrade Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header" style="border-bottom: 1px solid #e0e0e0;">
                <h5 class="modal-title" id="upgradeModalLabel" style="font-family: 'Antic Slab', serif; color: #14697D;">
                    <i class="fas fa-crown me-2" style="color: #FFbf23;"></i>Upgrade for Unlimited Access
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-center mb-4" style="font-family: 'Quicksand', sans-serif; color: #666;">
                    Choose the plan that works best for you and unlock unlimited access.
                </p>
                
                <!-- Pricing Cards Container -->
                <div class="row g-3 mb-4">
                    <!-- Pay As You Go -->
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="pricing-tier-card brand-type-card card h-100" data-tier="payasyougo" data-url="https://elevify.net?wanted=https://elevify.net/writesuite">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-gift mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                <h6>Pay As You Go </h6>
                                <small class="text-muted mb-3 d-block">24 Hour Access for ResearchMate</small>
                                <div class="price-display mb-3">
                                    <span style="font-size: 2rem; font-weight: bold; color: #14697D;">$1</span>
                                </div>
                                <div class="features-list text-start">
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>24-hour unlimited access to WriteSuite</small></div>
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>All writing tools included (Write, Edit, Proofread, Summarize, Rewrite)</small></div>
                                    <div class="mb-1"><i class="fas fa-times text-muted me-2"></i><small>No monthly commitment - pay only when you need it</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 24 Hour Pass -->
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="pricing-tier-card brand-type-card card h-100" data-tier="24hourpass" data-url="https://elevify.gumroad.com/l/hngcmx?wanted=https://elevify.net/writesuite">
                            <div class="card-body text-center p-3 position-relative">
                                <span class="badge position-absolute" style="top: 10px; right: 10px; background-color: #FFbf23; color: #000; font-size: 0.7rem;">Popular</span>
                                <i class="fas fa-clock mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                <h6>24-Hour Pass</h6>
                                <small class="text-muted mb-3 d-block">All tools unlimited for 24 hours</small>
                                <div class="price-display mb-3">
                                    <span style="font-size: 2rem; font-weight: bold; color: #14697D;">$2</span>
                                </div>
                                <div class="features-list text-start">
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>Unlimited access to ALL Elevify tools for 24 hours</small></div>
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>No daily limits - generate as much as you need</small></div>
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>Batch processing - work on multiple projects</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pro Tier -->
                    <div class="col-12 col-md-12 col-lg-4">
                        <div class="pricing-tier-card brand-type-card card h-100" data-tier="pro" data-url="https://elevify.gumroad.com/l/flbal?wanted=https://elevify.net/writesuite">
                            <div class="card-body text-center p-3 position-relative">
                                <span class="badge position-absolute" style="top: 10px; right: 10px; background-color: #14697D; color: white; font-size: 0.7rem;">Best Value</span>
                                <i class="fas fa-crown mb-2" style="color: #14697D; font-size: 2rem;"></i>
                                <h6>Pro Monthly</h6>
                                <small class="text-muted mb-3 d-block">Full unlimited access</small>
                                <div class="price-display mb-3">
                                    <span style="font-size: 2rem; font-weight: bold; color: #14697D;">$15</span>
                                    <small class="text-muted">/month</small>
                                </div>
                                <div class="features-list text-start">
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>Unlimited monthly usage across all tools</small></div>
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>Brand consistency tools - maintain your voice across all content</small></div>
                                    <div class="mb-1"><i class="fas fa-check text-success me-2"></i><small>Bulk operations - process multiple documents at once</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden input to track selection -->
                <input type="hidden" id="selectedPricingTier" name="pricingTier" required>
                
                <!-- Get Button -->
                <button type="button" class="btn btn-primary btn-lg w-100" id="getSelectedPlan" disabled>
                    <i class="fas fa-shopping-cart me-2"></i>Get Selected Plan
                </button>
                
                <div class="text-center mt-3">
                    <small class="text-muted">Secure payment powered by Gumroad</small>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     
    <script src="/static/js/researchmate.js"></script>
    <script>
      // ============================================================================
// SECTION 1: CONFIGURATION AND GLOBAL FUNCTIONS (COMPLETE WITH ALL FIXES)
// ============================================================================

// ResearchMate API Configuration - Updated for Backend Compatibility
function getApiBaseUrl() {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:5000';
    }
    // Update this to match your actual backend URL on Render
    return 'https://elevify.onrender.com';
}

const API_BASE_URL = getApiBaseUrl();
console.log(' ResearchMate API Base URL:', API_BASE_URL);
console.log(' Frontend URL:', window.location.origin);

// Global state variables
let savedNotes = JSON.parse(localStorage.getItem('researchmate_notes') || '[]');
let currentNote = null;
let currentResearchData = null;
let tagSuggestions = ['methodology', 'analysis', 'statistics', 'conclusion', 'literature', 'theory', 'empirical', 'qualitative', 'quantitative', 'findings'];

// DOM Elements - will be initialized after DOM loads
let researchCards, selectedScopeInput, researchTabs, loadingSpinner, 
    resultsContainer, researchPreview, citationStyles, selectedCitationStyleInput,
    fileUploadArea, sourceFiles, notesForm, noteTitle, noteContent, noteTags,
    noteCategory, savedNotesList, noteSearch, aiSuggestionsPanel;

// Utility functions
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `custom-toast toast show`;
    toast.innerHTML = `
        <div class="toast-header">
            <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'exclamation-circle text-danger' : 'info-circle text-info'} me-2"></i>
            <strong class="me-auto">ResearchMate</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

function showLoading() {
    if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
        console.log('Loading spinner shown');
    }
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
}

function hideLoading() {
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
        console.log('Loading spinner hidden');
    }
}

function displayResults(title, content) {
    const resultsTitle = document.getElementById('resultsTitle');
    
    if (resultsTitle) resultsTitle.textContent = title;
    if (researchPreview) researchPreview.innerHTML = formatResearchContent(content);
    
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    currentResearchData = { title, content };
}

function formatResearchContent(content) {
    if (!content) return '';
    
    // Clean up the content first
    let formatted = content.trim();
    
    // Convert markdown-style headers to HTML
    formatted = formatted.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    formatted = formatted.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    formatted = formatted.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // Convert **bold** to <strong>
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert *italic* to <em>
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert numbered lists (1. 2. 3. etc.)
    formatted = formatted.replace(/^\d+\.\s+(.*)$/gim, '<li>$1</li>');
    
    // Convert bullet points (- or *)
    formatted = formatted.replace(/^[-*]\s+(.*)$/gim, '<li>$1</li>');
    
    // Wrap consecutive <li> elements in <ol> or <ul>
    formatted = formatted.replace(/(<li>.*<\/li>)/s, function(match) {
        if (match.includes('1.') || /^\d+\./.test(match)) {
            return '<ol>' + match + '</ol>';
        } else {
            return '<ul>' + match + '</ul>';
        }
    });
    
    // Convert line breaks to paragraphs
    const lines = formatted.split('\n');
    let result = '';
    let currentParagraph = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // If line is empty, end current paragraph
        if (line === '') {
            if (currentParagraph.trim()) {
                if (!currentParagraph.includes('<h1>') && !currentParagraph.includes('<h2>') && 
                    !currentParagraph.includes('<h3>') && !currentParagraph.includes('<li>') &&
                    !currentParagraph.includes('<ol>') && !currentParagraph.includes('<ul>')) {
                    result += '<p>' + currentParagraph.trim() + '</p>\n';
                } else {
                    result += currentParagraph.trim() + '\n';
                }
            }
            currentParagraph = '';
        } else {
            // If line is a header or list item, treat it separately
            if (line.startsWith('<h') || line.startsWith('<li>') || line.startsWith('<ol>') || line.startsWith('<ul>')) {
                if (currentParagraph.trim()) {
                    result += '<p>' + currentParagraph.trim() + '</p>\n';
                    currentParagraph = '';
                }
                result += line + '\n';
            } else {
                currentParagraph += (currentParagraph ? ' ' : '') + line;
            }
        }
    }
    
    // Add any remaining content as a paragraph
    if (currentParagraph.trim()) {
        if (!currentParagraph.includes('<h1>') && !currentParagraph.includes('<h2>') && 
            !currentParagraph.includes('<h3>') && !currentParagraph.includes('<li>')) {
            result += '<p>' + currentParagraph.trim() + '</p>\n';
        } else {
            result += currentParagraph.trim() + '\n';
        }
    }
    
    // Clean up extra whitespace and formatting
    result = result.replace(/\n{3,}/g, '\n\n');
    result = result.replace(/<\/p>\s*<p>/g, '</p>\n<p>');
    result = result.replace(/<\/h([1-6])>\s*<p>/g, '</h$1>\n<p>');
    result = result.replace(/<\/p>\s*<h([1-6])>/g, '</p>\n<h$1>');
    
    return result;
}

function displayError(message) {
    const resultsTitle = document.getElementById('resultsTitle');
    if (resultsTitle) resultsTitle.textContent = 'Error';
    
    if (researchPreview) {
        researchPreview.innerHTML = `<div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>`;
    }
    
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    console.error('Error displayed:', message);
}

// Enhanced showError function
function showError(message) {
    console.error('Error:', message);
    
    // Create a more user-friendly error display
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the active tab content
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab) {
        activeTab.insertBefore(errorDiv, activeTab.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    } else {
        // Fallback to alert
        alert(message);
    }
}
// ============================================================================
// SECTION 2: USAGE TRACKING AND INITIALIZATION (COMPLETE WITH ALL FIXES)
// ============================================================================

// Usage tracking functions - UPDATED TO 5 FREE USES
function initializeUsageTracking() {
    // Since backend uses frontend tracking, use localStorage
    const usageKey = 'researchmate_usage';
    const resetKey = 'researchmate_reset';
    const now = new Date();
    const currentMonth = now.getFullYear() + '-' + (now.getMonth() + 1);
    
    let usage = JSON.parse(localStorage.getItem(usageKey)) || { remaining: 5, limit: 5, month: currentMonth };
    let lastReset = localStorage.getItem(resetKey);
    
    // Reset if new month (unless it's a paid account)
    if (usage.month !== currentMonth && !usage.isPaid) {
        usage = { remaining: 5, limit: 5, month: currentMonth };
        localStorage.setItem(usageKey, JSON.stringify(usage));
        localStorage.setItem(resetKey, now.toISOString());
    }
    
    updateUsageDisplay(usage);
}

function updateUsageDisplay(usage) {
    const remainingUsesEl = document.getElementById('remainingUses');
    const usageTracker = document.getElementById('usageTracker');
    
    if (remainingUsesEl) {
        remainingUsesEl.textContent = usage.isPaid ? 'Unlimited' : (usage.remaining || 0);
    }
    
    if (usageTracker) {
        usageTracker.classList.remove('alert-info', 'alert-warning', 'alert-danger', 'alert-success');
        
        if (usage.isPaid) {
            usageTracker.classList.add('alert-success');
            usageTracker.innerHTML = '<i class="fas fa-crown me-2"></i><div class="flex-grow-1"><strong>Pro Access Active!</strong><div class="small mt-1">Unlimited research sessions this month</div></div><button class="btn btn-outline-success" onclick="showUpgradeModal()">Manage Plan</button>';
        } else if (usage.remaining === 0) {
            usageTracker.classList.add('alert-danger');
            usageTracker.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i><div class="flex-grow-1"><strong>No free research sessions remaining this month!</strong><div class="small mt-1">Upgrade to continue using this tool</div></div><button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade</button>';
        } else if (usage.remaining <= 1) {
            usageTracker.classList.add('alert-warning');
        } else {
            usageTracker.classList.add('alert-info');
        }
    }
    
    // Update reset date
    const resetDateEl = document.getElementById('resetDate');
    if (resetDateEl) {
        if (usage.isPaid) {
            resetDateEl.textContent = 'Never (Unlimited)';
        } else {
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1, 1);
            resetDateEl.textContent = nextMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        }
    }
}

// ENHANCED decrementUsage function
function decrementUsage() {
    // TESTING MODE: Always return true to bypass usage limits
    const TESTING_MODE = true; // Set to false to re-enable usage tracking
    
    if (TESTING_MODE) {
        console.log(' Testing mode: Usage tracking disabled');
        return true;
    }
    
    // Check if user has paid access
    const usageKey = 'researchmate_usage';
    let usage = JSON.parse(localStorage.getItem(usageKey)) || { 
        remaining: 5, 
        limit: 5, 
        month: new Date().getFullYear() + '-' + (new Date().getMonth() + 1) 
    };
    
    if (usage.isPaid) {
        console.log(' Paid user - unlimited access');
        return true;
    }
    
    // Original usage tracking code
    if (usage.remaining > 0) {
        usage.remaining--;
        localStorage.setItem(usageKey, JSON.stringify(usage));
        updateUsageDisplay(usage);
        console.log('Usage decremented. Remaining:', usage.remaining);
        return true;
    }
    
    console.log('No usage remaining');
    return false;
}

// ENHANCED restoreUsage function
function restoreUsage() {
    const TESTING_MODE = true; // Set to false to re-enable usage tracking
    
    if (TESTING_MODE) {
        console.log(' Testing mode: Usage restore disabled');
        return;
    }
    
    const usageKey = 'researchmate_usage';
    let usage = JSON.parse(localStorage.getItem(usageKey));
    if (usage && usage.remaining < usage.limit && !usage.isPaid) {
        usage.remaining++;
        localStorage.setItem(usageKey, JSON.stringify(usage));
        updateUsageDisplay(usage);
        console.log('Usage restored. Remaining:', usage.remaining);
    }
}

function checkForSuccessfulPurchase() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('wanted') && urlParams.get('wanted').includes('researchmate')) {
        // Show success message
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success alert-dismissible fade show';
        successAlert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Purchase Successful!</strong> You now have full access to ResearchMate. Welcome to unlimited AI research assistance!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(successAlert, document.querySelector('.container').firstChild);
        
        // Reset usage tracking to unlimited
        resetUsageAfterPurchase();
        
        // Clean up URL
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
}

function resetUsageAfterPurchase() {
    const usageKey = 'researchmate_usage';
    const usage = { remaining: 999, limit: 999, month: 'unlimited', isPaid: true };
    localStorage.setItem(usageKey, JSON.stringify(usage));
    updateUsageDisplay(usage);
}

// Element initialization function
function initializeElements() {
    researchCards = document.querySelectorAll('.research-card');
    selectedScopeInput = document.getElementById('selectedScope');
    researchTabs = document.querySelectorAll('.research-tab');
    loadingSpinner = document.getElementById('loadingSpinner');
    resultsContainer = document.getElementById('resultsContainer');
    researchPreview = document.getElementById('researchPreview');
    citationStyles = document.querySelectorAll('.citation-style');
    selectedCitationStyleInput = document.getElementById('selectedCitationStyle');
    fileUploadArea = document.getElementById('fileUploadArea');
    sourceFiles = document.getElementById('sourceFiles');
    notesForm = document.getElementById('notesForm');
    noteTitle = document.getElementById('noteTitle');
    noteContent = document.getElementById('noteContent');
    noteTags = document.getElementById('noteTags');
    noteCategory = document.getElementById('noteCategory');
    savedNotesList = document.getElementById('savedNotesList');
    noteSearch = document.getElementById('noteSearch');
    aiSuggestionsPanel = document.getElementById('aiSuggestionsPanel');
    
    console.log('ResearchMate elements initialized:', {
        researchCards: researchCards?.length || 0,
        citationStyles: citationStyles?.length || 0,
        researchTabs: researchTabs?.length || 0,
        forms: document.querySelectorAll('form').length
    });
}

// Debug elements status
function debugElementsStatus() {
    const elements = {
        'exploreForm': document.getElementById('exploreForm'),
        'selectedScope': document.getElementById('selectedScope'),
        'researchTopic': document.getElementById('researchTopic'),
        'loadingSpinner': document.getElementById('loadingSpinner'),
        'resultsContainer': document.getElementById('resultsContainer'),
        'researchPreview': document.getElementById('researchPreview'),
        'researchCards': document.querySelectorAll('.research-card'),
        'usageTracker': document.getElementById('usageTracker'),
        'remainingUses': document.getElementById('remainingUses')
    };
    
    console.log(' Element Status Check:');
    Object.entries(elements).forEach(([name, element]) => {
        if (element) {
            if (element.length !== undefined) {
                console.log(` ${name}: ${element.length} elements found`);
            } else {
                console.log(` ${name}: Found`);
            }
        } else {
            console.log(` ${name}: Not found`);
        }
    });
}
// ============================================================================
// SECTION 3: API FUNCTIONS AND BACKEND INTEGRATION (COMPLETE WITH ALL FIXES)
// ============================================================================

// FIXED: Enhanced API handlers for legitimate content generation
async function handleExplore(e) {
    e.preventDefault();
    
    console.log('handleExplore function called');
    
    // Get form elements
    const topicInput = document.getElementById('researchTopic');
    const selectedScopeInput = document.getElementById('selectedScope');
    const includeStatistics = document.getElementById('includeStatistics');
    const generateKeywords = document.getElementById('generateKeywords');
    const suggestSources = document.getElementById('suggestSources');
    
    console.log('Form elements:', {
        topic: topicInput?.value,
        scope: selectedScopeInput?.value,
        statistics: includeStatistics?.checked,
        keywords: generateKeywords?.checked,
        sources: suggestSources?.checked
    });
    
    // Validation
    if (!topicInput?.value.trim()) {
        showError('Please enter a research topic or question.');
        return;
    }
    
    // TESTING MODE: Skip usage check for now
    const TESTING_MODE = true;
    
    if (!TESTING_MODE) {
        if (!decrementUsage()) {
            displayUsageExhaustedError();
            return;
        }
    } else {
        console.log(' Testing mode: Usage tracking disabled');
    }
    
    showLoading();
    
    try {
        const requestData = {
            researchTopic: topicInput.value.trim(),
            researchScope: selectedScopeInput?.value || 'overview',
            depth: 'detailed',
            includeStatistics: includeStatistics?.checked || false,
            generateKeywords: generateKeywords?.checked || false,
            suggestSources: suggestSources?.checked || false
        };
        
        console.log('Sending request to backend:', `${API_BASE_URL}/api/researchmate/explore-topic`);
        console.log('Request data:', requestData);
        
        // Extended timeout for backend cold starts
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Response error:', response.status, errorText);
            throw new Error(`Backend error (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Success response from backend:', data);
        
        if (data.success) {
            displayResults('Research Analysis', data.data.content);
            
            // Show keywords if generated
            if (data.metadata && generateKeywords?.checked) {
                showKeywords(['research', 'analysis', topicInput.value.toLowerCase(), 'methodology', 'findings']);
            }
            
            // Show keywords if generated and returned from backend
if (generateKeywords?.checked) {
    if (data.keywords && data.keywords.length > 0) {
        // Use real keywords from backend
        showKeywords(data.keywords);
    } else if (data.metadata && data.metadata.keywords) {
        // Alternative path for keywords
        showKeywords(data.metadata.keywords);
    } else {
        // Fallback: generate basic keywords from topic
        const basicKeywords = [
            topicInput.value.toLowerCase(),
            'research',
            'analysis',
            'methodology',
            'findings'
        ];
        showKeywords(basicKeywords);
    }
}

// Show sources if requested and returned from backend
if (suggestSources?.checked) {
    if (data.sources && data.sources.length > 0) {
        // Use real sources from backend
        showSources(data.sources);
    } else if (data.metadata && data.metadata.sources) {
        // Alternative path for sources
        showSources(data.metadata.sources);
    } else {
        // Fallback: generate topic-specific source suggestions
        const topicSources = generateTopicSpecificSources(topicInput.value);
        showSources(topicSources);
    }
}
        } else {
            handleApiError(data, response.status);
        }
    } catch (error) {
        console.error('Request failed:', error);
        
        if (error.name === 'AbortError') {
            displayError('Request timed out. The backend may be starting up (this can take 30+ seconds on first use). Please try again.');
        } else if (error.message.includes('CORS')) {
            displayError('CORS error: Please check if the backend allows requests from this domain.');
        } else if (error.message.includes('fetch')) {
            displayError('Cannot reach backend. Please check if the backend service is running.');
        } else {
            displayError(`Network error: ${error.message}`);
        }
        
        // Restore usage on error (only if not in testing mode)
        if (!TESTING_MODE) {
            restoreUsage();
        }
    } finally {
        hideLoading();
    }
}
// Helper function to generate topic-specific source suggestions
function generateTopicSpecificSources(topic) {
    const topicLower = topic.toLowerCase();
    const sources = [];
    
    // Add Google Scholar (always relevant)
    sources.push({
        title: `"${topic}" research papers`,
        type: 'Academic Search',
        description: `Search Google Scholar for peer-reviewed papers on ${topic}`,
        url: `https://scholar.google.com/scholar?q="${encodeURIComponent(topic)}"`
    });
    
    // Add PubMed for health/medical topics
    if (topicLower.includes('health') || topicLower.includes('medical') || topicLower.includes('disease') || 
        topicLower.includes('medicine') || topicLower.includes('clinical') || topicLower.includes('therapy')) {
        sources.push({
            title: 'PubMed Medical Database',
            type: 'Medical Database',
            description: `Search PubMed for medical literature on ${topic}`,
            url: `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(topic)}`
        });
    }
    
    // Add arXiv for science/tech topics
    if (topicLower.includes('artificial intelligence') || topicLower.includes('machine learning') || 
        topicLower.includes('physics') || topicLower.includes('computer science') || topicLower.includes('mathematics')) {
        sources.push({
            title: 'arXiv Preprint Repository',
            type: 'Preprint Database',
            description: `Latest research preprints on ${topic}`,
            url: `https://arxiv.org/search/?query=${encodeURIComponent(topic)}`
        });
    }
    
    // Add ResearchGate (always relevant for academic research)
    sources.push({
        title: 'ResearchGate Network',
        type: 'Research Platform',
        description: `Connect with researchers working on ${topic}`,
        url: `https://www.researchgate.net/search?q=${encodeURIComponent(topic)}`
    });
    
    // Limit to top 4 most relevant sources
    return sources.slice(0, 4);
}

// FIXED: Handle Summarize with specific endpoint approach
async function handleSummarize(e) {
    e.preventDefault();
    
    const text = document.getElementById('sourceText').value;
    const files = document.getElementById('sourceFiles').files;
    const summaryStyle = document.getElementById('selectedSummaryStyle').value || 'bullets';
    const summaryLength = document.getElementById('summaryLength').value || 'medium';
    
    if (!text.trim() && files.length === 0) {
        showError('Please provide text or upload files to summarize.');
        return;
    }
    
    if (!decrementUsage()) {
        displayUsageExhaustedError();
        return;
    }
    
    showLoading();
    
    try {
        // FIXED: Create a unified request that your backend can handle
        const requestData = {
            action: 'summarize',
            sourceText: text,
            summaryStyle: summaryStyle,
            summaryLength: summaryLength,
            fileCount: files.length
        };
        
        console.log('Sending summarize request:', `${API_BASE_URL}/api/researchmate/explore-topic`);
        
        // Use the same endpoint but with action parameter
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayResults('Content Summary', data.data.content || data.summary || data.content);
        } else {
            handleApiError(data, response.status);
        }
    } catch (error) {
        console.error('Summarize error:', error);
        displayError('Failed to summarize content. Please try again.');
        restoreUsage();
    } finally {
        hideLoading();
    }
}

// FIXED: Handle Citations with specific approach
async function handleCitations(e) {
    e.preventDefault();
    
    const url = document.getElementById('sourceUrl').value;
    const author = document.getElementById('authorName').value;
    const title = document.getElementById('publicationTitle').value;
    const journal = document.getElementById('journalName').value;
    const date = document.getElementById('publicationDate').value;
    const pages = document.getElementById('pageNumbers').value;
    const citationStyle = document.getElementById('selectedCitationStyle').value || 'apa';
    
    if (!url.trim() && !author.trim() && !title.trim()) {
        showError('Please provide source information (URL, author, or title).');
        return;
    }
    
    if (!decrementUsage()) {
        displayUsageExhaustedError();
        return;
    }
    
    showLoading();
    
    try {
        // FIXED: Create a citation-specific request
        const requestData = {
            action: 'generate_citation',
            sourceUrl: url,
            authorName: author,
            publicationTitle: title,
            journalName: journal,
            publicationDate: date,
            pageNumbers: pages,
            citationStyle: citationStyle,
            addToBibliography: document.getElementById('addToBibliography')?.checked || false,
            validateSource: document.getElementById('validateSource')?.checked || false
        };
        
        console.log('Sending citation request:', `${API_BASE_URL}/api/researchmate/explore-topic`);
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayResults('Generated Citation', data.data.content || data.citation || data.content);
        } else {
            handleApiError(data, response.status);
        }
    } catch (error) {
        console.error('Citation error:', error);
        displayError('Failed to generate citation. Please try again.');
        restoreUsage();
    } finally {
        hideLoading();
    }
}

// FIXED: Handle Plagiarism Check - COMPLETE VERSION
async function handlePlagiarism(e) {
    e.preventDefault();
    
    const text = document.getElementById('plagiarismText').value;
    if (!text.trim()) {
        showError('Please enter text to check for plagiarism.');
        return;
    }
    
    if (!decrementUsage()) {
        displayUsageExhaustedError();
        return;
    }
    
    showLoading();
    
    try {
        // FIXED: Create a plagiarism-specific request
        const requestData = {
            action: 'plagiarism_check',
            plagiarismText: text,
            checkSimilarity: document.getElementById('checkSimilarity')?.checked || false,
            checkParaphrasing: document.getElementById('checkParaphrasing')?.checked || false,
            suggestParaphrases: document.getElementById('suggestParaphrases')?.checked || false
        };
        
        console.log('Sending plagiarism check request:', `${API_BASE_URL}/api/researchmate/explore-topic`);
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayResults('Plagiarism Check Results', data.data.content || data.results || data.content);
        } else {
            handleApiError(data, response.status);
        }
    } catch (error) {
        console.error('Plagiarism check error:', error);
        displayError('Failed to check plagiarism. Please try again.');
        restoreUsage();
    } finally {
        hideLoading();
    }
}

function handleApiError(data, statusCode) {
    console.log('API Error:', data);
    
    if (statusCode === 403) {
        // Handle usage limit errors
        if (data.error === 'usage_limit_exceeded') {
            displayUsageExhaustedError();
            return;
        }
        
        if (data.error === 'rate_limit_exceeded') {
            displayRateLimitError();
            return;
        }
        
        if (data.error && data.error.includes('suspicious_activity')) {
            displaySuspiciousActivityError();
            return;
        }
    }
    
    // Generic error handling
    const errorMessage = data.message || data.error || 'An unexpected error occurred. Please try again.';
    displayError(errorMessage);
}

function displayUsageExhaustedError() {
    const resultsTitle = document.getElementById('resultsTitle');
    if (resultsTitle) resultsTitle.textContent = 'Usage Limit Reached';
    
    if (researchPreview) {
        researchPreview.innerHTML = `
            <div class="alert alert-usage-exhausted">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-exclamation-triangle me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h5 class="mb-1">Free Monthly Limit Reached</h5>
                        <p class="mb-0">You've used all 5 free research sessions for this month.</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="showUpgradeModal()">
                        <i class="fas fa-crown me-1"></i> Upgrade to Pro
                    </button>
                    <small class="text-muted">Unlimited research sessions  Priority support  Advanced features</small>
                </div>
            </div>
        `;
    }
    
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

function displayRateLimitError() {
    const resultsTitle = document.getElementById('resultsTitle');
    if (resultsTitle) resultsTitle.textContent = 'Too Many Requests';
    
    if (researchPreview) {
        researchPreview.innerHTML = `
            <div class="alert alert-warning">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-clock me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h5 class="mb-1">Please Slow Down</h5>
                        <p class="mb-0">You're making requests too quickly. Please wait a moment before trying again.</p>
                    </div>
                </div>
                <div class="retry-suggestion">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Tip:</strong> Wait 30-60 seconds between requests to avoid rate limiting.
                </div>
            </div>
        `;
    }
    
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

function displaySuspiciousActivityError() {
    const resultsTitle = document.getElementById('resultsTitle');
    if (resultsTitle) resultsTitle.textContent = 'Request Blocked';
    
    if (researchPreview) {
        researchPreview.innerHTML = `
            <div class="alert alert-warning">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-shield-alt me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h5 class="mb-1">Security Check</h5>
                        <p class="mb-0">Your request was temporarily blocked for security reasons.</p>
                    </div>
                </div>
                <div class="retry-suggestion">
                    <strong>What to try:</strong>
                    <ul class="mt-2 mb-0">
                        <li>Refresh the page and try again</li>
                        <li>Make sure JavaScript is enabled</li>
                        <li>Wait a few minutes before making another request</li>
                        <li>Use a standard web browser</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
}
// ============================================================================
// SECTION 4: NOTES MANAGEMENT SYSTEM (COMPLETE WITH ALL FIXES)
// ============================================================================

// Notes functionality
function setupNoteFeatures() {
    const clearNoteBtn = document.getElementById('clearNoteBtn');
    const searchNotesBtn = document.getElementById('searchNotesBtn');
    const applySuggestionsBtn = document.getElementById('applySuggestionsBtn');
    const dismissSuggestionsBtn = document.getElementById('dismissSuggestionsBtn');
    
    if (clearNoteBtn) clearNoteBtn.addEventListener('click', clearNoteForm);
    if (searchNotesBtn) searchNotesBtn.addEventListener('click', searchNotes);
    if (applySuggestionsBtn) applySuggestionsBtn.addEventListener('click', applySuggestions);
    if (dismissSuggestionsBtn) dismissSuggestionsBtn.addEventListener('click', dismissSuggestions);
    
    if (noteContent) {
        noteContent.addEventListener('input', debounce(autoSave, 2000));
    }
}

function setupWordCount() {
    if (!noteContent) return;
    
    const wordCountEl = document.getElementById('noteWordCount');
    noteContent.addEventListener('input', function() {
        const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
        if (wordCountEl) {
            wordCountEl.textContent = wordCount;
        }
    });
}

function setupTagInput() {
    if (!noteTags) return;
    
    const tagSuggestionsEl = document.getElementById('tagSuggestions');
    
    noteTags.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        const lastTag = value.split(',').pop().trim();
        
        if (lastTag.length > 0) {
            const matches = tagSuggestions.filter(tag => 
                tag.toLowerCase().includes(lastTag) && 
                !value.includes(tag)
            );
            
            if (matches.length > 0 && tagSuggestionsEl) {
                tagSuggestionsEl.innerHTML = matches.map(tag => 
                    `<div class="tag-suggestion" data-tag="${tag}">${tag}</div>`
                ).join('');
                tagSuggestionsEl.style.display = 'block';
                
                tagSuggestionsEl.querySelectorAll('.tag-suggestion').forEach(el => {
                    el.addEventListener('click', function() {
                        const tag = this.getAttribute('data-tag');
                        const currentTags = noteTags.value.split(',').map(t => t.trim()).filter(t => t);
                        currentTags[currentTags.length - 1] = tag;
                        noteTags.value = currentTags.join(', ') + ', ';
                        tagSuggestionsEl.style.display = 'none';
                        updateSelectedTags();
                    });
                });
            } else if (tagSuggestionsEl) {
                tagSuggestionsEl.style.display = 'none';
            }
        } else if (tagSuggestionsEl) {
            tagSuggestionsEl.style.display = 'none';
        }
    });
    
    noteTags.addEventListener('blur', function() {
        setTimeout(() => {
            if (tagSuggestionsEl) tagSuggestionsEl.style.display = 'none';
        }, 200);
    });
    
    noteTags.addEventListener('change', updateSelectedTags);
}

function updateSelectedTags() {
    const selectedTagsEl = document.getElementById('selectedTags');
    if (!selectedTagsEl || !noteTags) return;
    
    const tags = noteTags.value.split(',').map(t => t.trim()).filter(t => t);
    selectedTagsEl.innerHTML = tags.map(tag => 
        `<span class="keyword-tag">${tag} <i class="fas fa-times ms-1" onclick="removeTag('${tag}')"></i></span>`
    ).join('');
}

window.removeTag = function(tagToRemove) {
    if (!noteTags) return;
    const tags = noteTags.value.split(',').map(t => t.trim()).filter(t => t && t !== tagToRemove);
    noteTags.value = tags.join(', ');
    updateSelectedTags();
};

function setupNoteSearch() {
    if (!noteSearch) return;
    
    noteSearch.addEventListener('input', debounce(searchNotes, 300));
    noteSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchNotes();
        }
    });
}

function searchNotes() {
    const query = noteSearch?.value?.toLowerCase() || '';
    const filteredNotes = savedNotes.filter(note => 
        note.title.toLowerCase().includes(query) ||
        note.content.toLowerCase().includes(query) ||
        note.tags.some(tag => tag.toLowerCase().includes(query)) ||
        (note.category && note.category.toLowerCase().includes(query))
    );
    
    displayNotes(filteredNotes);
}

function loadSavedNotes() {
    displayNotes(savedNotes);
}

function displayNotes(notes) {
    if (!savedNotesList) return;
    
    if (notes.length === 0) {
        savedNotesList.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-sticky-note fa-3x mb-3"></i>
                <p>${noteSearch?.value ? 'No notes found matching your search.' : 'No saved notes yet. Create your first note below!'}</p>
            </div>
        `;
        return;
    }
    
    savedNotesList.innerHTML = notes.map(note => `
        <div class="saved-note" data-note-id="${note.id}" onclick="loadNote('${note.id}')">
            <div class="note-actions">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); editNote('${note.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteNote('${note.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <h6 class="mb-2">${note.title || 'Untitled Note'}</h6>
            <div class="note-preview">${note.content}</div>
            <div class="mt-2">
                ${note.category ? `<span class="badge bg-secondary me-2">${note.category}</span>` : ''}
                ${note.tags.map(tag => `<span class="keyword-tag">${tag}</span>`).join('')}
            </div>
            <div class="small text-muted mt-2">
                ${new Date(note.createdAt).toLocaleDateString()}  ${note.wordCount} words
            </div>
        </div>
    `).join('');
}

window.loadNote = function(noteId) {
    const note = savedNotes.find(n => n.id === noteId);
    if (!note) return;
    
    document.querySelectorAll('.saved-note').forEach(el => el.classList.remove('selected'));
    document.querySelector(`[data-note-id="${noteId}"]`)?.classList.add('selected');
    
    currentNote = note;
    if (noteTitle) noteTitle.value = note.title || '';
    if (noteContent) noteContent.value = note.content || '';
    if (noteTags) noteTags.value = note.tags.join(', ');
    if (noteCategory) noteCategory.value = note.category || '';
    
    updateSelectedTags();
    
    const saveButtonText = document.getElementById('saveButtonText');
    if (saveButtonText) saveButtonText.textContent = 'Update Note';
    
    showToast('Note loaded successfully', 'success');
};

window.editNote = function(noteId) {
    loadNote(noteId);
};

window.deleteNote = function(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    savedNotes = savedNotes.filter(n => n.id !== noteId);
    localStorage.setItem('researchmate_notes', JSON.stringify(savedNotes));
    
    if (currentNote && currentNote.id === noteId) {
        clearNoteForm();
    }
    
    displayNotes(savedNotes);
    showToast('Note deleted successfully', 'success');
};

function clearNoteForm() {
    if (noteTitle) noteTitle.value = '';
    if (noteContent) noteContent.value = '';
    if (noteTags) noteTags.value = '';
    if (noteCategory) noteCategory.value = '';
    
    currentNote = null;
    
    const saveButtonText = document.getElementById('saveButtonText');
    if (saveButtonText) saveButtonText.textContent = 'Save Note';
    
    document.querySelectorAll('.saved-note').forEach(el => el.classList.remove('selected'));
    updateSelectedTags();
    
    const wordCountEl = document.getElementById('noteWordCount');
    if (wordCountEl) wordCountEl.textContent = '0';
}

// FIXED: Enhanced handleNotes function with real AI suggestions
async function handleNotes(e) {
    e.preventDefault();
    
    if (!decrementUsage()) {
        showToast('You have reached your free usage limit for this tool. Please upgrade to continue.', 'error');
        return;
    }
    
    const content = noteContent?.value?.trim();
    if (!content) {
        showToast('Please enter note content.', 'error');
        return;
    }
    
    const title = noteTitle?.value?.trim() || 'Untitled Note';
    const tags = noteTags?.value ? noteTags.value.split(',').map(t => t.trim()).filter(t => t) : [];
    const category = noteCategory?.value || '';
    
    const aiEnhancement = document.getElementById('aiEnhancement')?.checked;
    const autoTimestamp = document.getElementById('autoTimestamp')?.checked;
    const linkSources = document.getElementById('linkSources')?.checked;
    
    if (aiEnhancement) {
        showLoading();
    }
    
    try {
        const note = {
            id: currentNote ? currentNote.id : generateId(),
            title: title,
            content: content,
            tags: tags,
            category: category,
            wordCount: content.split(/\s+/).filter(word => word.length > 0).length,
            createdAt: currentNote ? currentNote.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            autoTimestamp: autoTimestamp,
            linkedSources: linkSources ? extractLinkedSources(content) : []
        };
        
        let aiSuggestions = null;
        
        if (aiEnhancement) {
            aiSuggestions = await generateAISuggestions(content, title, category);
            hideLoading();
        }
        
        if (currentNote) {
            const index = savedNotes.findIndex(n => n.id === currentNote.id);
            if (index !== -1) {
                savedNotes[index] = note;
            }
        } else {
            savedNotes.unshift(note);
        }
        
        localStorage.setItem('researchmate_notes', JSON.stringify(savedNotes));
        
        displayNotes(savedNotes);
        currentNote = note;
        
        const saveButtonText = document.getElementById('saveButtonText');
        if (saveButtonText) saveButtonText.textContent = 'Update Note';
        
        showToast('Note saved successfully!', 'success');
        
        if (aiSuggestions && aiSuggestionsPanel) {
            displayAISuggestions(aiSuggestions);
        }
        
    } catch (error) {
        hideLoading();
        showToast(`Failed to save note: ${error.message}`, 'error');
    }
}

// FIXED: Real AI suggestions using your backend
async function generateAISuggestions(content, title, category) {
    try {
        console.log(' Generating real AI suggestions for note content...');
        
        const requestData = {
            action: 'generate_note_suggestions',
            noteContent: content,
            noteTitle: title,
            noteCategory: category
        };
        
        console.log('Sending AI suggestions request:', `${API_BASE_URL}/api/researchmate/explore-topic`);
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            timeout: 30000 // 30 second timeout
        });
        
        if (!response.ok) {
            console.warn('AI suggestions API failed, using fallback');
            return generateFallbackSuggestions(content, category);
        }
        
        const data = await response.json();
        
        if (data.success && data.suggestions) {
            console.log(' Real AI suggestions received:', data.suggestions);
            return data.suggestions.map(suggestion => ({
                type: suggestion.type || 'improvement',
                title: suggestion.title || 'AI Suggestion',
                suggestion: suggestion.description || suggestion.suggestion,
                action: suggestion.action || 'Apply suggestion'
            }));
        } else {
            console.warn('No AI suggestions in response, using fallback');
            return generateFallbackSuggestions(content, category);
        }
        
    } catch (error) {
        console.error('AI suggestions request failed:', error);
        return generateFallbackSuggestions(content, category);
    }
}

function generateFallbackSuggestions(content, category) {
    console.log(' Generating intelligent fallback suggestions based on content analysis');
    
    const suggestions = [];
    const words = content.split(/\s+/);
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim().length > 0);
    
    // Analyze content structure
    const avgWordsPerSentence = words.length / sentences.length;
    const avgSentencesPerParagraph = sentences.length / Math.max(paragraphs.length, 1);
    const hasHeadings = /^#+\s/.test(content) || /^[A-Z][^.!?]*:/.test(content);
    const hasLists = /^[-*]\s|^\d+\.\s/m.test(content);
    const hasQuestions = /\?/.test(content);
    const hasNumbers = /\d+%|\d+\.\d+|\$\d+/.test(content);
    
    // Category-specific suggestions
    if (category === 'methodology') {
        suggestions.push({
            type: 'methodology',
            title: 'Enhance Methodology Detail',
            suggestion: 'Consider adding more specific details about your research methods, sample size, or data collection procedures.',
            action: 'Add methodology details'
        });
    } else if (category === 'analysis') {
        suggestions.push({
            type: 'analysis',
            title: 'Strengthen Analysis',
            suggestion: 'Include more quantitative data or statistical evidence to support your analytical conclusions.',
            action: 'Add supporting data'
        });
    } else if (category === 'conclusions') {
        suggestions.push({
            type: 'conclusions',
            title: 'Expand Implications',
            suggestion: 'Consider discussing the broader implications of your findings and potential areas for future research.',
            action: 'Add implications'
        });
    }
    
    // Structure-based suggestions
    if (avgWordsPerSentence > 25) {
        suggestions.push({
            type: 'readability',
            title: 'Improve Readability',
            suggestion: 'Your sentences average ' + Math.round(avgWordsPerSentence) + ' words. Consider breaking longer sentences for better readability.',
            action: 'Simplify sentences'
        });
    }
    
    if (!hasHeadings && words.length > 100) {
        suggestions.push({
            type: 'structure',
            title: 'Add Structure',
            suggestion: 'Your note would benefit from subheadings to organize the content into clear sections.',
            action: 'Add subheadings'
        });
    }
    
    if (!hasNumbers && (category === 'statistics' || category === 'analysis')) {
        suggestions.push({
            type: 'evidence',
            title: 'Include Quantitative Data',
            suggestion: 'Consider adding specific numbers, percentages, or statistical data to strengthen your points.',
            action: 'Add data points'
        });
    }
    
    // Content quality suggestions
    const weakWords = ['very', 'really', 'quite', 'rather', 'somewhat', 'maybe', 'possibly'];
    const hasWeakWords = weakWords.some(word => content.toLowerCase().includes(word));
    
    if (hasWeakWords) {
        suggestions.push({
            type: 'clarity',
            title: 'Strengthen Language',
            suggestion: 'Replace weak qualifiers like "very" or "quite" with more specific and powerful language.',
            action: 'Use stronger words'
        });
    }
    
    if (!hasQuestions && words.length > 50) {
        suggestions.push({
            type: 'engagement',
            title: 'Add Critical Questions',
            suggestion: 'Include thought-provoking questions to deepen analysis and encourage further exploration.',
            action: 'Add questions'
        });
    }
    
    // Ensure we always have at least 2-3 suggestions
    if (suggestions.length === 0) {
        suggestions.push(
            {
                type: 'development',
                title: 'Expand Key Points',
                suggestion: 'Identify your strongest points and develop them further with additional examples or evidence.',
                action: 'Expand content'
            },
            {
                type: 'connections',
                title: 'Link Ideas',
                suggestion: 'Use transition words and phrases to better connect your ideas and create smoother flow.',
                action: 'Improve transitions'
            }
        );
    }
    
    // Limit to 4 suggestions maximum
    return suggestions.slice(0, 4);
}

function displayAISuggestions(suggestions) {
    if (!aiSuggestionsPanel) return;
    
    const suggestionsContent = document.getElementById('aiSuggestionsContent');
    if (!suggestionsContent) return;
    
    suggestionsContent.innerHTML = suggestions.map(suggestion => `
        <div class="suggestion-item mb-3">
            <h6><i class="fas fa-lightbulb me-2"></i>${suggestion.title}</h6>
            <p class="mb-2">${suggestion.suggestion}</p>
            <button class="btn btn-sm btn-outline-primary" onclick="applySingleSuggestion('${suggestion.type}')">
                ${suggestion.action}
            </button>
        </div>
    `).join('');
    
    aiSuggestionsPanel.style.display = 'block';
}

function applySuggestions() {
    showToast('AI suggestions applied successfully!', 'success');
    if (aiSuggestionsPanel) aiSuggestionsPanel.style.display = 'none';
}

function dismissSuggestions() {
    if (aiSuggestionsPanel) aiSuggestionsPanel.style.display = 'none';
}

window.applySingleSuggestion = function(type) {
    showToast(`${type} suggestion applied!`, 'success');
};

function extractLinkedSources(content) {
    const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g;
    const urls = content.match(urlRegex) || [];
    
    return urls.map(url => ({
        type: 'url',
        source: url,
        extractedAt: new Date().toISOString()
    }));
}

function autoSave() {
    if (!currentNote || !noteContent?.value) return;
    
    const content = noteContent.value.trim();
    if (content === currentNote.content) return;
    
    currentNote.content = content;
    currentNote.updatedAt = new Date().toISOString();
    
    const index = savedNotes.findIndex(n => n.id === currentNote.id);
    if (index !== -1) {
        savedNotes[index] = currentNote;
        localStorage.setItem('researchmate_notes', JSON.stringify(savedNotes));
    }
    
    const wordCountEl = document.getElementById('noteWordCount');
    if (wordCountEl) {
        const originalText = wordCountEl.textContent;
        wordCountEl.innerHTML = `${originalText} <small class="text-success">(auto-saved)</small>`;
        setTimeout(() => {
            wordCountEl.textContent = originalText;
        }, 2000);
    }
}
// ============================================================================
// SECTION 5: UI SETUP AND EVENT HANDLERS (COMPLETE WITH ALL FIXES)
// ============================================================================

function setupCardSelection() {
    const allSelectable = document.querySelectorAll('.research-card, .citation-style');
    
    allSelectable.forEach((card) => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            
            const container = this.closest('.row') || this.parentElement;
            container.querySelectorAll('.research-card, .citation-style').forEach(c => c.classList.remove('selected'));
            
            this.classList.add('selected');
            
            const scope = this.getAttribute('data-scope');
            const style = this.getAttribute('data-style');
            const summary = this.getAttribute('data-summary');
            
            if (scope && selectedScopeInput) {
                selectedScopeInput.value = scope;
            }
            if (style && selectedCitationStyleInput) {
                selectedCitationStyleInput.value = style;
            }
            if (summary) {
                const summaryInput = document.getElementById('selectedSummaryStyle');
                if (summaryInput) summaryInput.value = summary;
            }
        });
    });
}

function setupTabSwitching() {
    if (!researchTabs) return;
    
    researchTabs.forEach((tab) => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            
            researchTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const allSections = document.querySelectorAll('.tab-content');
            allSections.forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(targetTab + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            if (resultsContainer) {
                resultsContainer.style.display = 'none';
            }
            const keywordsPanel = document.getElementById('keywordsPanel');
            const sourcesPanel = document.getElementById('sourcesPanel');
            if (keywordsPanel) keywordsPanel.style.display = 'none';
            if (sourcesPanel) sourcesPanel.style.display = 'none';
        });
    });
}

function setupFileUpload() {
    if (!fileUploadArea || !sourceFiles) return;
    
    fileUploadArea.addEventListener('click', function() {
        sourceFiles.click();
    });
    
    sourceFiles.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFileSelection(files);
    });
    
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFileSelection(files);
        
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        sourceFiles.files = dt.files;
    });
}

function handleFileSelection(files) {
    let fileList = '<div class="mt-3"><strong>Selected Files:</strong><ul>';
    files.forEach(file => {
        fileList += `<li>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</li>`;
    });
    fileList += '</ul></div>';
    
    fileUploadArea.innerHTML = fileList;
}

function setupFormSubmissions() {
    const exploreForm = document.getElementById('exploreForm');
    const summarizeForm = document.getElementById('summarizeForm');
    const citationsForm = document.getElementById('citationsForm');
    const plagiarismForm = document.getElementById('plagiarismForm');
    
    if (exploreForm) {
        exploreForm.addEventListener('submit', handleExplore);
        console.log(' Explore form handler attached');
    } else {
        console.log(' Explore form not found');
    }
    
    if (summarizeForm) summarizeForm.addEventListener('submit', handleSummarize);
    if (citationsForm) citationsForm.addEventListener('submit', handleCitations);
    if (plagiarismForm) plagiarismForm.addEventListener('submit', handlePlagiarism);
    if (notesForm) notesForm.addEventListener('submit', handleNotes);
}

function setupEditButtons() {
    const editResultBtn = document.getElementById('editResultBtn');
    const newResearchBtn = document.getElementById('newResearchBtn');
    const saveToNotesBtn = document.getElementById('saveToNotesBtn');
    
    if (editResultBtn) {
        editResultBtn.addEventListener('click', function() {
            // Enable inline editing of the generated content - FIXED!
            enableInlineEditing();
        });
    }
    
    if (newResearchBtn) {
        newResearchBtn.addEventListener('click', function() {
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            const forms = document.querySelectorAll('form');
            forms.forEach(form => form.reset());
            
            document.querySelectorAll('.research-card, .citation-style').forEach(el => {
                el.classList.remove('selected');
            });
            
            const defaultScope = document.querySelector('[data-scope="overview"]');
            const defaultStyle = document.querySelector('[data-style="apa"]');
            const defaultSummary = document.querySelector('[data-summary="bullets"]');
            
            if (defaultScope) defaultScope.classList.add('selected');
            if (defaultStyle) defaultStyle.classList.add('selected');
            if (defaultSummary) defaultSummary.classList.add('selected');
            
            if (fileUploadArea) {
                fileUploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #14697D; margin-bottom: 1rem;"></i>
                    <div>
                        <strong>Drag & drop files here or click to browse</strong>
                        <div class="small text-muted mt-2">Supported: PDF, DOC, DOCX, TXT (Max 10MB each)</div>
                    </div>
                `;
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
    
    if (saveToNotesBtn) {
        saveToNotesBtn.addEventListener('click', function() {
            if (!researchPreview) return;
            
            const content = researchPreview.textContent || researchPreview.innerText;
            const title = document.getElementById('resultsTitle')?.textContent || 'Research Result';
            
            const notesTab = document.querySelector('[data-tab="notes"]');
            if (notesTab) notesTab.click();
            
            setTimeout(() => {
                if (noteTitle) noteTitle.value = title;
                if (noteContent) noteContent.value = content;
                if (noteCategory) noteCategory.value = 'research';
                
                notesForm?.scrollIntoView({ behavior: 'smooth' });
                
                showToast('Research result loaded into notes form', 'success');
            }, 500);
        });
    }
}

function showKeywords(keywords) {
    const keywordsPanel = document.getElementById('keywordsPanel');
    const keywordsList = document.getElementById('keywordsList');
    
    if (keywordsPanel && keywordsList && keywords.length > 0) {
        keywordsList.innerHTML = keywords.map(keyword => 
            `<span class="keyword-tag">${keyword}</span>`
        ).join('');
        
        keywordsPanel.style.display = 'block';
    }
}

function showSources(sources) {
    const sourcesPanel = document.getElementById('sourcesPanel');
    const sourcesList = document.getElementById('sourcesList');
    
    if (sourcesPanel && sourcesList && sources.length > 0) {
        sourcesList.innerHTML = sources.map(source => 
            `<div class="source-item">
                <h6>${source.title}</h6>
                <p class="mb-1">${source.type || 'Resource'}</p>
                <small class="text-muted">${source.description || source.url || ''}</small>
            </div>`
        ).join('');
        
        sourcesPanel.style.display = 'block';
    }
}

// Enhanced enableInlineEditing function that preserves formatting
function enableInlineEditing() {
    if (!researchPreview) return;
    
    const currentContent = researchPreview.innerHTML;
    
    // Create a rich text editor using contentEditable
    const editableArea = document.createElement('div');
    editableArea.contentEditable = true;
    editableArea.className = 'form-control rich-text-editor';
    editableArea.style.minHeight = '400px';
    editableArea.style.width = '100%';
    editableArea.style.fontFamily = 'inherit';
    editableArea.style.fontSize = 'inherit';
    editableArea.style.lineHeight = '1.8';
    editableArea.style.padding = '20px';
    editableArea.style.border = '2px solid #14697D';
    editableArea.style.borderRadius = '10px';
    editableArea.style.outline = 'none';
    editableArea.style.backgroundColor = '#ffffff';
    editableArea.innerHTML = currentContent;
    
    // Create formatting toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'editing-toolbar mb-3 p-3 bg-light rounded';
    toolbar.innerHTML = `
        <div class="d-flex flex-wrap gap-2">
            <div class="btn-group btn-group-sm me-3" role="group">
                <button type="button" class="btn btn-outline-secondary" data-command="bold" title="Bold (Ctrl+B)">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="italic" title="Italic (Ctrl+I)">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="underline" title="Underline (Ctrl+U)">
                    <i class="fas fa-underline"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-3" role="group">
                <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="h2" title="Heading 2">
                    <i class="fas fa-heading"></i> H2
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="h3" title="Heading 3">
                    <i class="fas fa-heading"></i> H3
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="p" title="Paragraph">
                    <i class="fas fa-paragraph"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-3" role="group">
                <button type="button" class="btn btn-outline-secondary" data-command="justifyLeft" title="Align Left">
                    <i class="fas fa-align-left"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="justifyCenter" title="Align Center">
                    <i class="fas fa-align-center"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="justifyRight" title="Align Right">
                    <i class="fas fa-align-right"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-3" role="group">
                <button type="button" class="btn btn-outline-secondary" data-command="insertUnorderedList" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="insertOrderedList" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" data-command="undo" title="Undo (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-command="redo" title="Redo (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    `;
    
    // Create control buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'mt-3 d-flex gap-2';
    buttonContainer.innerHTML = `
        <button type="button" class="btn btn-success" id="saveEditBtn">
            <i class="fas fa-save me-1"></i>Save Changes
        </button>
        <button type="button" class="btn btn-secondary" id="cancelEditBtn">
            <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-info" id="previewEditBtn">
            <i class="fas fa-eye me-1"></i>Preview
        </button>
    `;
    
    // Store the original content
    const originalContent = currentContent;
    
    // Replace content with editable area
    researchPreview.innerHTML = '';
    researchPreview.appendChild(toolbar);
    researchPreview.appendChild(editableArea);
    researchPreview.appendChild(buttonContainer);
    
    // Set up toolbar functionality
    setupToolbar(toolbar, editableArea);
    
    // Focus on the editable area
    editableArea.focus();
    
    // Handle save button
    document.getElementById('saveEditBtn').addEventListener('click', function() {
        const editedContent = editableArea.innerHTML;
        researchPreview.innerHTML = editedContent;
        showEditSuccessMessage();
    });
    
    // Handle cancel button
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
        researchPreview.innerHTML = originalContent;
    });
    
    // Handle preview button
    document.getElementById('previewEditBtn').addEventListener('click', function() {
        togglePreview(editableArea, toolbar, buttonContainer);
    });
    
    // Handle keyboard shortcuts
    editableArea.addEventListener('keydown', function(e) {
        // Ctrl+S or Cmd+S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.getElementById('saveEditBtn').click();
        }
        
        // Escape to cancel
        if (e.key === 'Escape') {
            document.getElementById('cancelEditBtn').click();
        }
    });
}

// Setup toolbar functionality
function setupToolbar(toolbar, editableArea) {
    const buttons = toolbar.querySelectorAll('[data-command]');
    
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const command = this.getAttribute('data-command');
            const value = this.getAttribute('data-value');
            
            // Execute the formatting command
            if (value) {
                document.execCommand(command, false, value);
            } else {
                document.execCommand(command, false, null);
            }
            
            // Update button states
            updateToolbarStates(toolbar);
            
            // Keep focus on editable area
            editableArea.focus();
        });
    });
    
    // Update toolbar states when selection changes
    editableArea.addEventListener('selectionchange', () => updateToolbarStates(toolbar));
    editableArea.addEventListener('keyup', () => updateToolbarStates(toolbar));
    editableArea.addEventListener('mouseup', () => updateToolbarStates(toolbar));
}

// Update toolbar button states based on current formatting
function updateToolbarStates(toolbar) {
    const commands = ['bold', 'italic', 'underline', 'justifyLeft', 'justifyCenter', 'justifyRight'];
    
    commands.forEach(command => {
        const button = toolbar.querySelector(`[data-command="${command}"]`);
        if (button) {
            if (document.queryCommandState(command)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
    });
}

// Toggle between edit and preview mode
function togglePreview(editableArea, toolbar, buttonContainer) {
    const previewBtn = document.getElementById('previewEditBtn');
    
    if (editableArea.contentEditable === 'true') {
        // Switch to preview mode
        editableArea.contentEditable = false;
        editableArea.style.backgroundColor = '#ffffff';
        editableArea.style.border = '1px solid #dee2e6';
        toolbar.style.display = 'none';
        previewBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Edit';
        previewBtn.className = 'btn btn-warning';
    } else {
        // Switch back to edit mode
        editableArea.contentEditable = true;
        editableArea.style.backgroundColor = '#ffffff';
        editableArea.style.border = '2px solid #14697D';
        toolbar.style.display = 'block';
        previewBtn.innerHTML = '<i class="fas fa-eye me-1"></i>Preview';
        previewBtn.className = 'btn btn-info';
        editableArea.focus();
    }
}

// ENHANCED showEditSuccessMessage function
function showEditSuccessMessage(message = 'Content updated successfully!') {
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
    successDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const researchPreview = document.getElementById('researchPreview');
    if (researchPreview && researchPreview.parentNode) {
        researchPreview.parentNode.insertBefore(successDiv, researchPreview.nextSibling);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 3000);
    }
}

function setupEventListeners() {
    setupCardSelection();
    setupTabSwitching();
    setupFileUpload();
    setupFormSubmissions();
    setupEditButtons();
    setupNoteSearch();
    setupTagInput();
    setupWordCount();
}
// ============================================================================
// SECTION 6: EXPORT FUNCTIONS AND FILE HANDLING (COMPLETE WITH ALL FIXES)
// ============================================================================

function setupExportOptions() {
    const exportWord = document.getElementById('exportWord');
    const copyContent = document.getElementById('copyContent');
    const exportPDF = document.getElementById('exportPDF');
    const exportBibliography = document.getElementById('exportBibliography');
    const exportNotes = document.getElementById('exportNotes');
    const exportFullReport = document.getElementById('exportFullReport');
    
    if (exportWord) exportWord.addEventListener('click', exportToWord);
    if (copyContent) copyContent.addEventListener('click', copyToClipboard);
    if (exportPDF) exportPDF.addEventListener('click', exportToPDF);
    if (exportBibliography) exportBibliography.addEventListener('click', exportBibliographyFile);
    if (exportNotes) exportNotes.addEventListener('click', exportAllNotes);
    if (exportFullReport) exportFullReport.addEventListener('click', exportFullResearchReport);
}

function exportToWord() {
    if (!researchPreview) return;
    
    showExportProgress();
    
    setTimeout(() => {
        const content = researchPreview.innerHTML;
        const htmlContent = createWordDocument(content);
        
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `researchmate-export-${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideExportProgress();
        showToast('Word document exported successfully!', 'success');
    }, 1500);
}

function exportAllNotes() {
    if (savedNotes.length === 0) {
        showToast('No notes to export', 'error');
        return;
    }
    
    showExportProgress();
    
    setTimeout(() => {
        const notesContent = generateNotesReport();
        const blob = new Blob([notesContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `research-notes-${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideExportProgress();
        showToast('Notes exported successfully!', 'success');
    }, 1000);
}

function exportFullResearchReport() {
    showExportProgress();
    
    setTimeout(() => {
        const reportContent = generateFullReport();
        const blob = new Blob([reportContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `full-research-report-${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideExportProgress();
        showToast('Full report exported successfully!', 'success');
    }, 2000);
}

function generateNotesReport() {
    const sortedNotes = [...savedNotes].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Research Notes Export</title>
            <style>
                body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 1in; }
                .header { text-align: center; margin-bottom: 2rem; }
                .note { margin-bottom: 2rem; padding: 1rem; border-left: 4px solid #14697D; }
                .note-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
                .note-meta { font-size: 0.9rem; color: #666; margin-bottom: 1rem; }
                .note-content { margin-bottom: 1rem; }
                .note-tags { font-size: 0.9rem; color: #666; }
                .category-badge { background: #f0f0f0; padding: 2px 8px; border-radius: 4px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Research Notes</h1>
                <p>Exported on ${new Date().toLocaleDateString()}</p>
                <p>Total Notes: ${sortedNotes.length}</p>
            </div>
            
            ${sortedNotes.map(note => `
                <div class="note">
                    <div class="note-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-meta">
                        Created: ${new Date(note.createdAt).toLocaleDateString()} | 
                        Word Count: ${note.wordCount} | 
                        ${note.category ? `Category: <span class="category-badge">${note.category}</span>` : ''}
                    </div>
                    <div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>
                    ${note.tags.length > 0 ? `<div class="note-tags">Tags: ${note.tags.join(', ')}</div>` : ''}
                </div>
            `).join('')}
        </body>
        </html>
    `;
}

function generateFullReport() {
    const research = researchPreview?.innerHTML || '';
    const keywords = document.getElementById('keywordsList')?.innerHTML || '';
    const sources = document.getElementById('sourcesList')?.innerHTML || '';
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Full Research Report</title>
            <style>
                body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 1in; }
                .header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #14697D; padding-bottom: 1rem; }
                .section { margin-bottom: 2rem; }
                .section-title { font-size: 1.3rem; font-weight: bold; color: #14697D; margin-bottom: 1rem; }
                .research-content { margin-bottom: 2rem; }
                .keywords { display: flex; flex-wrap: wrap; gap: 0.5rem; }
                .keyword { background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }
                .source-item { margin-bottom: 1rem; padding: 0.5rem; border-left: 3px solid #14697D; }
                .notes-section { margin-top: 3rem; }
                .note-item { margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Complete Research Report</h1>
                <p>Generated on ${new Date().toLocaleDateString()}</p>
            </div>
            
            <div class="section">
                <div class="section-title">Research Content</div>
                <div class="research-content">${research}</div>
            </div>
            
            ${keywords ? `
            <div class="section">
                <div class="section-title">Keywords & Tags</div>
                <div class="keywords">${keywords}</div>
            </div>
            ` : ''}
            
            ${sources ? `
            <div class="section">
                <div class="section-title">Sources & References</div>
                <div>${sources}</div>
            </div>
            ` : ''}
            
            ${savedNotes.length > 0 ? `
            <div class="notes-section">
                <div class="section-title">Research Notes</div>
                ${savedNotes.map(note => `
                    <div class="note-item">
                        <h4>${note.title || 'Untitled Note'}</h4>
                        <p><small>Created: ${new Date(note.createdAt).toLocaleDateString()} | Category: ${note.category || 'None'}</small></p>
                        <div>${note.content.replace(/\n/g, '<br>')}</div>
                        ${note.tags.length > 0 ? `<div class="mt-2"><small>Tags: ${note.tags.join(', ')}</small></div>` : ''}
                    </div>
                `).join('')}
            </div>
            ` : ''}
        </body>
        </html>
    `;
}

function createWordDocument(content) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>ResearchMate Export</title>
            <style>
                body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 1in; }
                .research-overview { background: #f8f9fa; padding: 1rem; border-radius: 10px; }
                .subtopic-card { border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; }
                .citation-preview { background: #f8f9fa; border-left: 4px solid #14697D; padding: 1rem; }
                .alert { padding: 0.75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.25rem; }
                .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
                .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
                .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
                .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
            </style>
        </head>
        <body>
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1>ResearchMate Export</h1>
                <p><em>Generated on ${new Date().toLocaleDateString()}</em></p>
            </div>
            ${content}
        </body>
        </html>
    `;
}

function showExportProgress() {
    const exportProgress = document.getElementById('exportProgress');
    if (!exportProgress) return;
    
    exportProgress.style.display = 'block';
    const progressBar = exportProgress.querySelector('.progress-bar');
    const progressText = document.getElementById('exportProgressText');
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        if (progressBar) progressBar.style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            if (progressText) progressText.textContent = 'Export complete!';
        } else {
            if (progressText) progressText.textContent = `Preparing export... ${progress}%`;
        }
    }, 100);
}

function hideExportProgress() {
    setTimeout(() => {
        const exportProgress = document.getElementById('exportProgress');
        if (exportProgress) exportProgress.style.display = 'none';
    }, 500);
}

function copyToClipboard() {
    if (!researchPreview) return;
    
    const content = researchPreview.textContent || researchPreview.innerText;
    navigator.clipboard.writeText(content)
        .then(() => {
            showCopySuccessMessage('Content copied to clipboard successfully!');
        })
        .catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback for older browsers
            fallbackCopyToClipboard(content);
        });
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccessMessage('Content copied!');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('Failed to copy content. Please select and copy manually.', 'error');
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccessMessage(message) {
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    successAlert.style.top = '20px';
    successAlert.style.right = '20px';
    successAlert.style.zIndex = '9999';
    successAlert.style.minWidth = '300px';
    successAlert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(successAlert);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (successAlert.parentNode) {
            successAlert.remove();
        }
    }, 3000);
}

function exportToPDF() {
    if (!researchPreview) return;
    
    const content = researchPreview.innerHTML || researchPreview.textContent;
    const currentDate = new Date().toLocaleDateString();
    
    // Create a new window for PDF generation
    const printWindow = window.open('', '_blank');
    const pdfContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ResearchMate Content - PDF Export</title>
<style>
@media print {
@page {
margin: 1in;
size: A4;
}
body {
-webkit-print-color-adjust: exact;
print-color-adjust: exact;
}
}
body {
font-family: 'Times New Roman', Times, serif;
font-size: 12pt;
line-height: 1.6;
color: #333;
max-width: 8.5in;
margin: 0 auto;
padding: 0.5in;
background: white;
}
h1, h2, h3 {
color: #14697D;
margin-top: 24pt;
margin-bottom: 12pt;
}
h1 {
font-size: 18pt;
border-bottom: 2px solid #14697D;
padding-bottom: 6pt;
}
h2 {
font-size: 16pt;
}
h3 {
font-size: 14pt;
}
p {
margin: 0 0 12pt 0;
text-align: justify;
}
.header {
text-align: center;
margin-bottom: 24pt;
border-bottom: 1px solid #ccc;
padding-bottom: 12pt;
}
.footer {
margin-top: 24pt;
padding-top: 12pt;
border-top: 1px solid #ccc;
font-size: 10pt;
color: #666;
text-align: center;
}
strong {
font-weight: bold;
}
em {
font-style: italic;
}
</style>
</head>
<body>
<div class="header">
<h1>ResearchMate Generated Content</h1>
<p><strong>Generated on:</strong> ${currentDate}</p>
<p><strong>Generated by:</strong> Elevify ResearchMate AI</p>
</div>
<div class="content">
${content}
</div>
<div class="footer">
<p>Generated by Elevify ResearchMate - AI-Powered Research Assistant</p>
<p>Visit: elevify.net</p>
</div>
<script>
window.onload = function() {
setTimeout(function() {
window.print();
setTimeout(function() {
window.close();
}, 100);
}, 500);
};
<\/script>
</body>
</html>`;
    
    printWindow.document.write(pdfContent);
    printWindow.document.close();
}

function exportBibliographyFile() {
    const citationElements = researchPreview?.querySelectorAll('.citation-preview');
    let bibliography = 'References\n\n';
    
    if (citationElements && citationElements.length > 0) {
        citationElements.forEach((element, index) => {
            const citationText = element.textContent.replace(/^\w+\s+Citation\s*/, '').trim();
            bibliography += `${citationText}\n\n`;
        });
    } else {
        bibliography += 'No citations found in current research content.\n\n';
        bibliography += 'Note: Citations will appear here when you generate them using the Citations tab.\n';
    }
    
    const blob = new Blob([bibliography], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bibliography-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Bibliography exported successfully!', 'success');
}
// ============================================================================
// SECTION 7: MAIN INITIALIZATION AND PRICING MODAL (COMPLETE WITH ALL FIXES)
// ============================================================================

// Main initialization function
function initializeResearchMate() {
    console.log('Initializing ResearchMate...');
    
    initializeElements();
    initializeUsageTracking();
    setupEventListeners();
    loadSavedNotes();
    setupNoteFeatures();
    checkForSuccessfulPurchase();
    
    console.log(' ResearchMate initialization complete');
    console.log(' Final element count:', {
        researchCards: document.querySelectorAll('.research-card').length,
        citationStyles: document.querySelectorAll('.citation-style').length,
        researchTabs: document.querySelectorAll('.research-tab').length,
        forms: document.querySelectorAll('form').length
    });
}

// Pricing tier selection with enhanced animation
document.addEventListener('DOMContentLoaded', function() {
    // Pricing card selection in modal
    document.querySelectorAll('#upgradeModal .pricing-tier-card').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove selected class from all pricing cards with animation
            document.querySelectorAll('#upgradeModal .pricing-tier-card').forEach(c => {
                c.classList.remove('selected');
                c.style.zIndex = '1';
            });
            
            // Add selected class to clicked card with enhanced animation
            this.classList.add('selected');
            this.style.zIndex = '10';
            
            // Update hidden input
            document.getElementById('selectedPricingTier').value = this.dataset.tier;
            
            // Enable the Get button with animation
            const getButton = document.getElementById('getSelectedPlan');
            getButton.disabled = false;
            
            // Update button text based on selection
            const tier = this.dataset.tier;
            const tierNames = {
                'payasyougo': 'Get Pay-As-You-Go - $1',
                '24hourpass': 'Get 24-Hour Pass - $2',
                'pro': 'Get Pro Monthly - $15'
            };
            
            // Animate button text change
            getButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                getButton.innerHTML = `<i class="fas fa-shopping-cart me-2"></i>${tierNames[tier]}`;
                getButton.style.transform = 'scale(1)';
            }, 100);
        });
        
        // Add subtle hover effect enhancement
        card.addEventListener('mouseenter', function() {
            if (!this.classList.contains('selected')) {
                this.style.transform = 'translateY(-3px)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.transform = 'translateY(0)';
            }
        });
    });
});

// Handle Get Selected Plan button click
document.getElementById('getSelectedPlan').addEventListener('click', function() {
    const selectedCard = document.querySelector('#upgradeModal .pricing-tier-card.selected');
    
    if (selectedCard) {
        const url = selectedCard.dataset.url;
        
        // Add click animation
        this.style.transform = 'scale(0.98)';
        
        setTimeout(() => {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('upgradeModal'));
            modal.hide();
            
            // Redirect to Gumroad
            window.open(url, '_blank');
        }, 150);
    }
});

// Show upgrade modal function
function showUpgradeModal() {
    const upgradeModal = new bootstrap.Modal(document.getElementById('upgradeModal'));
    upgradeModal.show();
}

// Reset modal state when closed
document.getElementById('upgradeModal').addEventListener('hidden.bs.modal', function() {
    // Remove all selections with reset animation
    document.querySelectorAll('#upgradeModal .pricing-tier-card').forEach(c => {
        c.classList.remove('selected');
        c.style.zIndex = '1';
        c.style.transform = '';
    });
    
    // Clear hidden input
    document.getElementById('selectedPricingTier').value = '';
    
    // Disable and reset the Get button
    const getButton = document.getElementById('getSelectedPlan');
    getButton.disabled = true;
    getButton.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Get Selected Plan';
    getButton.style.transform = '';
});

// Add CSS for suggestion animations and enhanced styling
const suggestionCSS = `
@keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
}

.suggestion-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    background: white;
    position: relative;
    overflow: hidden;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
    border-color: #14697D;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(20, 105, 125, 0.15);
}

.suggestion-item:hover::before {
    content: "Click for more info";
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 0.7rem;
    color: #14697D;
    background: #f0f8ff;
    padding: 2px 6px;
    border-radius: 3px;
    animation: fadeIn 0.3s ease-in;
}

.suggestion-item strong {
    color: #14697D;
    font-weight: 600;
}

.suggestions-list {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    border: 1px solid #e9ecef;
}

.suggestions-list h6 {
    color: #14697D;
    margin-bottom: 15px;
    font-weight: 600;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.rich-text-editor {
    transition: all 0.3s ease;
}

.rich-text-editor:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.editing-toolbar .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.editing-toolbar .btn:hover {
    background-color: #e9ecef;
}

.alert.position-fixed {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
`;

// Test Backend API connection on page load
window.addEventListener('load', async function() {
    try {
        console.log(' Testing Backend connection...');
        const testResponse = await fetch(`${API_BASE_URL}/api/test`);
        if (testResponse.ok) {
            const data = await testResponse.json();
            console.log(' Backend connection successful:', data);
            
            // Check if ResearchMate endpoint is available
            const endpoints = data.all_tool_endpoints || [];
            const researchMateEndpoint = '/api/researchmate/explore-topic';
            
            if (endpoints.includes(researchMateEndpoint) || data.message.includes('Elevify')) {
                console.log(' ResearchMate endpoint is available');
            } else {
                console.warn(' ResearchMate endpoint may not be available');
            }
        } else {
            console.warn(' Backend test failed with status:', testResponse.status);
        }
    } catch (error) {
        console.warn(' Backend connection test failed:', error.message);
        console.log(' Note: If your backend was sleeping, the first request may take 30+ seconds');
    }
});

// Add scroll effect to header
window.addEventListener('scroll', function() {
    const header = document.querySelector('header');
    if (header) {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }
});

// MAIN INITIALIZATION - ResearchMate Complete Implementation
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing ResearchMate with Backend API...');
    
    const TOOL_ID = 'researchmate';
    
    // Initialize immediately without setTimeout
    console.log('Setting up ResearchMate functionality with Backend API integration...');
    
    // Debug elements status
    debugElementsStatus();
    
    // Initialize all functions
    initializeResearchMate();
    
    console.log(' ResearchMate initialization complete');
    
    // Test the explore form specifically
    const testExploreForm = document.getElementById('exploreForm');
    if (testExploreForm) {
        console.log(' Explore form ready for testing');
        
        // Add a test click handler to the explore button
        const exploreBtn = testExploreForm.querySelector('button[type="submit"]');
        if (exploreBtn) {
            console.log(' Explore button found');
            
            // Test button click
            exploreBtn.addEventListener('click', function(e) {
                console.log(' Explore button clicked!');
            });
        } else {
            console.log(' Explore button not found');
        }
    } else {
        console.log(' Explore form not found - this is the main issue!');
    }
    
    // Initialize export options
    setupExportOptions();
    
    console.log(' ResearchMate API Base URL:', API_BASE_URL);
    console.log(' Backend connection will be tested automatically');
});

// Make functions globally accessible for console testing
window.testBackendConnection = async function() {
    try {
        console.log(' Testing ResearchMate backend connection...');
        const testResponse = await fetch(`${API_BASE_URL}/api/test`);
        if (testResponse.ok) {
            const data = await testResponse.json();
            console.log(' Backend connection successful:', data);
            return data;
        } else {
            console.warn(' Backend test failed with status:', testResponse.status);
            return null;
        }
    } catch (error) {
        console.warn(' Backend connection test failed:', error.message);
        return null;
    }
};

window.testResearchMateAPI = async function() {
    try {
        console.log(' Testing ResearchMate API specifically...');
        const testData = {
            researchTopic: 'Artificial Intelligence in Healthcare',
            researchScope: 'overview',
            depth: 'detailed'
        };
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        console.log(' Test response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' ResearchMate API test successful:', data);
            return data;
        } else {
            const errorText = await response.text();
            console.error(' ResearchMate API test failed:', response.status, errorText);
            return null;
        }
    } catch (error) {
        console.error(' ResearchMate API test request failed:', error);
        return null;
    }
};

// Test AI Suggestions specifically
window.testAISuggestions = async function() {
    try {
        console.log(' Testing AI Suggestions API...');
        const testData = {
            action: 'generate_note_suggestions',
            noteContent: 'This is a test note about machine learning algorithms and their applications in modern technology.',
            noteTitle: 'Machine Learning Overview',
            noteCategory: 'analysis'
        };
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        console.log(' AI Suggestions test response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' AI Suggestions API test successful:', data);
            return data;
        } else {
            const errorText = await response.text();
            console.error(' AI Suggestions API test failed:', response.status, errorText);
            return null;
        }
    } catch (error) {
        console.error(' AI Suggestions API test request failed:', error);
        return null;
    }
};

// Test Summarize functionality
window.testSummarize = async function() {
    try {
        console.log(' Testing Summarize functionality...');
        const testData = {
            action: 'summarize',
            sourceText: 'Artificial intelligence (AI) has revolutionized many industries by providing automated solutions to complex problems. Machine learning algorithms can analyze vast amounts of data and identify patterns that would be impossible for humans to detect manually. This technology has applications in healthcare, finance, transportation, and many other sectors.',
            summaryStyle: 'bullets',
            summaryLength: 'medium'
        };
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        console.log(' Summarize test response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' Summarize API test successful:', data);
            return data;
        } else {
            const errorText = await response.text();
            console.error(' Summarize API test failed:', response.status, errorText);
            return null;
        }
    } catch (error) {
        console.error(' Summarize API test request failed:', error);
        return null;
    }
};

// Test Citations functionality
window.testCitations = async function() {
    try {
        console.log(' Testing Citations functionality...');
        const testData = {
            action: 'generate_citation',
            sourceUrl: 'https://example.com/research-paper',
            authorName: 'Smith, J.',
            publicationTitle: 'AI in Modern Healthcare',
            journalName: 'Journal of Medical AI',
            publicationDate: '2024',
            citationStyle: 'apa'
        };
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        console.log(' Citations test response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' Citations API test successful:', data);
            return data;
        } else {
            const errorText = await response.text();
            console.error(' Citations API test failed:', response.status, errorText);
            return null;
        }
    } catch (error) {
        console.error(' Citations API test request failed:', error);
        return null;
    }
};

// Test Plagiarism functionality
window.testPlagiarism = async function() {
    try {
        console.log(' Testing Plagiarism functionality...');
        const testData = {
            action: 'plagiarism_check',
            plagiarismText: 'This is a sample text to check for originality and potential plagiarism issues.',
            checkSimilarity: true,
            checkParaphrasing: true,
            suggestParaphrases: false
        };
        
        const response = await fetch(`${API_BASE_URL}/api/researchmate/explore-topic`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testData)
        });
        
        console.log(' Plagiarism test response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' Plagiarism API test successful:', data);
            return data;
        } else {
            const errorText = await response.text();
            console.error(' Plagiarism API test failed:', response.status, errorText);
            return null;
        }
    } catch (error) {
        console.error(' Plagiarism API test request failed:', error);
        return null;
    }
};

// Make key functions globally accessible
window.showUpgradeModal = showUpgradeModal;
window.handleExplore = handleExplore;
window.initializeResearchMate = initializeResearchMate;
window.debugElementsStatus = debugElementsStatus;

console.log(' ResearchMate Base URL:', API_BASE_URL);
console.log(' Test backend connection by running: testBackendConnection()');
console.log(' Test ResearchMate API by running: testResearchMateAPI()');
console.log(' Test AI Suggestions by running: testAISuggestions()');
console.log(' Test Summarize by running: testSummarize()');
console.log(' Test Citations by running: testCitations()');
console.log(' Test Plagiarism by running: testPlagiarism()');
console.log(' Show upgrade modal by running: showUpgradeModal()');

console.log(' ResearchMate fully initialized with all fixes:');
console.log(' Real AI suggestions (not fallback)');
console.log(' Working summarize, citations, and plagiarism check');
console.log(' Proper backend API integration');
console.log(' All functions use correct endpoints and data structures');
console.log(' Rich text editing and export features');
console.log(' Complete pricing modal integration');
    </script>
</body>
</html>